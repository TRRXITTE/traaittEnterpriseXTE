"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const prompts_1 = __importDefault(require("prompts"));
const chalk_1 = __importDefault(require("chalk"));
const connector_1 = __importDefault(require("./connector"));
const email_validator_1 = __importDefault(require("email-validator"));
const messages_1 = __importDefault(require("./messages"));
const get_default_project_link_1 = __importDefault(require("./get-default-project-link"));
const config_storage_1 = __importDefault(require("../dashboard/config-storage"));
const formatting_1 = require("./formatting");
const documentation_url_1 = __importDefault(require("./documentation-url"));
const dashboardConnector = new connector_1.default();
const dashboardConfigStorage = new config_storage_1.default();
async function registerInDashboard() {
    formatting_1.info(messages_1.default.REGISTRATION_ENTER_EMAIL_INVITATION);
    const { email } = await prompts_1.default({
        type: 'text',
        name: 'email',
        message: messages_1.default.PROMPT_EMAIL_CAPTION,
        validate: (input) => {
            if (!email_validator_1.default.validate(input))
                return messages_1.default.PROMPT_INVALID_EMAIL;
            return true;
        },
    });
    if (!email) {
        formatting_1.error(messages_1.default.REGISTRATION_CANCELLED);
        return;
    }
    const sendEmailResult = await dashboardConnector.sendEmail(email);
    if (!sendEmailResult.success) {
        const sendEmailErrorMessage = sendEmailResult.isDashboardError
            ? sendEmailResult.errorMessage
            : messages_1.default.REGISTRATION_EMAIL_SENDING_NETWORK_ERROR;
        formatting_1.error(sendEmailErrorMessage);
        return;
    }
    formatting_1.info(messages_1.default.REGISTRATION_EMAIL_SENT);
    const { token } = await prompts_1.default({
        type: 'text',
        name: 'token',
        message: messages_1.default.PROMPT_TOKEN_CAPTION,
    });
    if (!token) {
        formatting_1.error(messages_1.default.REGISTRATION_CANCELLED);
        return;
    }
    const validationResult = await dashboardConnector.validateToken(token);
    if (!validationResult.success) {
        const validationResultErrorMessage = validationResult.isDashboardError
            ? validationResult.errorMessage
            : messages_1.default.TOKEN_VALIDATION_NETWORK_ERROR;
        formatting_1.error(validationResultErrorMessage);
        return;
    }
    dashboardConfigStorage.options.sendReport = true;
    await saveNewToken(token);
    formatting_1.success(messages_1.default.REGISTRATION_FINISHED);
    formatting_1.info('View test results at:\n' +
        `${chalk_1.default.underline.blueBright(get_default_project_link_1.default(token))}`);
    formatting_1.info(`Run ${chalk_1.default.black.bgWhiteBright('testcafe dashboard off')} to disable this behavior.` +
        `Learn more at:\n${chalk_1.default.underline.blueBright(documentation_url_1.default)}`);
}
async function saveNewToken(token) {
    dashboardConfigStorage.options.token = token;
    await dashboardConfigStorage.save();
}
async function updateDefaultToken() {
    if (!dashboardConfigStorage.options.sendReport)
        formatting_1.warning(messages_1.default.TOKEN_UPDATING_NOT_SEND_REPORT);
    // NOTE: for the formatting reason
    formatting_1.info('');
    const { doYouWantToUpdateDefaultToken } = await prompts_1.default({
        type: 'confirm',
        name: 'doYouWantToUpdateDefaultToken',
        message: 'Your setup includes a default Dashboard token. Do you want to change it?:',
    });
    if (!doYouWantToUpdateDefaultToken) {
        formatting_1.error(messages_1.default.TOKEN_UPDATE_CANCELLED);
        return;
    }
    // NOTE: for the formatting reason
    formatting_1.info('');
    const { newToken } = await prompts_1.default({
        type: 'text',
        name: 'newToken',
        message: 'Enter the new default token value:',
    });
    if (!newToken) {
        formatting_1.error(messages_1.default.TOKEN_UPDATE_CANCELLED);
        return;
    }
    const validationResult = await dashboardConnector.validateToken(newToken);
    if (!validationResult.success) {
        const validationResultErrorMessage = validationResult.isDashboardError
            ? validationResult.errorMessage
            : messages_1.default.TOKEN_VALIDATION_NETWORK_ERROR;
        formatting_1.error(validationResultErrorMessage);
        return;
    }
    await saveNewToken(newToken);
    formatting_1.success(messages_1.default.TOKEN_UPDATED);
}
async function setSendReportState(state) {
    const sendReportAsBoolean = state === 'on';
    dashboardConfigStorage.options.sendReport = sendReportAsBoolean;
    await dashboardConfigStorage.save();
    const resultMessage = sendReportAsBoolean ? messages_1.default.SEND_REPORT_STATE_ON : messages_1.default.SEND_REPORT_STATE_OFF;
    formatting_1.success(resultMessage);
}
async function tryToRegisterInDashboard() {
    formatting_1.info(messages_1.default.TOKEN_NO_DEFAULT_FOUND);
    const { launchConfigurationWizard } = await prompts_1.default({
        type: 'confirm',
        name: 'launchConfigurationWizard',
        message: 'Do you want to launch the configuration wizard?',
        initial: true,
    });
    if (!launchConfigurationWizard) {
        formatting_1.error(messages_1.default.REGISTRATION_CANCELLED);
        return;
    }
    await registerInDashboard();
}
async function default_1(sendReportState) {
    const storageExists = await dashboardConfigStorage.load();
    if (sendReportState !== void 0) {
        if (storageExists)
            await setSendReportState(sendReportState);
        else
            await tryToRegisterInDashboard();
        return;
    }
    const thereIsDefaultToken = !!dashboardConfigStorage.options.token;
    if (thereIsDefaultToken)
        await updateDefaultToken();
    else
        await registerInDashboard();
}
exports.default = default_1;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGFzaGJvYXJkL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQThCO0FBQzlCLGtEQUEwQjtBQUMxQiw0REFBNkM7QUFDN0Msc0VBQTZDO0FBQzdDLDBEQUFrQztBQUNsQywwRkFBK0Q7QUFDL0QsaUZBQWlFO0FBR2pFLDZDQUtzQjtBQUV0Qiw0RUFBOEQ7QUFFOUQsTUFBTSxrQkFBa0IsR0FBTyxJQUFJLG1CQUFrQixFQUFFLENBQUM7QUFDeEQsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLHdCQUFzQixFQUFFLENBQUM7QUFFNUQsS0FBSyxVQUFVLG1CQUFtQjtJQUM5QixpQkFBSSxDQUFDLGtCQUFRLENBQUMsbUNBQW1DLENBQUMsQ0FBQztJQUVuRCxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxpQkFBTyxDQUFDO1FBQzVCLElBQUksRUFBTSxNQUFNO1FBQ2hCLElBQUksRUFBTSxPQUFPO1FBQ2pCLE9BQU8sRUFBRyxrQkFBUSxDQUFDLG9CQUFvQjtRQUN2QyxRQUFRLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRTtZQUN4QixJQUFJLENBQUMseUJBQWMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO2dCQUMvQixPQUFPLGtCQUFRLENBQUMsb0JBQW9CLENBQUM7WUFFekMsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztLQUNKLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDUixrQkFBSyxDQUFDLGtCQUFRLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUV2QyxPQUFPO0tBQ1Y7SUFFRCxNQUFNLGVBQWUsR0FBRyxNQUFNLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUVsRSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRTtRQUMxQixNQUFNLHFCQUFxQixHQUFHLGVBQWUsQ0FBQyxnQkFB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QixFQUFFO1FBQzVCLGtCQUFLLENBQUMsa0JBQVEsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBRXZDLE9BQU87S0FDVjtJQUVELE1BQU0sbUJBQW1CLEVBQUUsQ0FBQztBQUNoQyxDQUFDO0FBRWMsS0FBSyxvQkFBVyxlQUFnQztJQUMzRCxNQUFNLGFBQWEsR0FBRyxNQUFNLHNCQUFzQixDQUFDLElBQUksRUFBRSxDQUFDO0lBRTFELElBQUksZUFBZSxLQUFLLEtBQUssQ0FBQyxFQUFFO1FBQzVCLElBQUksYUFBYTtZQUNiLE1BQU0sa0JBQWtCLENBQUMsZUFBZSxDQUFDLENBQUM7O1lBRTFDLE1BQU0sd0JBQXdCLEVBQUUsQ0FBQztRQUVyQyxPQUFPO0tBQ1Y7SUFFRCxNQUFNLG1CQUFtQixHQUFHLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBRW5FLElBQUksbUJBQW1CO1FBQ25CLE1BQU0sa0JBQWtCLEVBQUUsQ0FBQzs7UUFFM0IsTUFBTSxtQkFBbUIsRUFBRSxDQUFDO0FBQ3BDLENBQUM7QUFsQkQsNEJBa0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHByb21wdHMgZnJvbSAncHJvbXB0cyc7XG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IERhc2hib2FyZENvbm5lY3RvciBmcm9tICcuL2Nvbm5lY3Rvcic7XG5pbXBvcnQgZW1haWxWYWxpZGF0b3IgZnJvbSAnZW1haWwtdmFsaWRhdG9yJztcbmltcG9ydCBtZXNzYWdlcyBmcm9tICcuL21lc3NhZ2VzJztcbmltcG9ydCBnZXREZWZhdWx0UHJvamVjdExpbmsgZnJvbSAnLi9nZXQtZGVmYXVsdC1wcm9qZWN0LWxpbmsnO1xuaW1wb3J0IERhc2hib2FyZENvbmZpZ1N0b3JhZ2UgZnJvbSAnLi4vZGFzaGJvYXJkL2NvbmZpZy1zdG9yYWdlJztcbmltcG9ydCB7IFNlbmRSZXBvcnRTdGF0ZSB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5cbmltcG9ydCB7XG4gICAgaW5mbyxcbiAgICB3YXJuaW5nLFxuICAgIGVycm9yLFxuICAgIHN1Y2Nlc3MsXG59IGZyb20gJy4vZm9ybWF0dGluZyc7XG5cbmltcG9ydCBEQVNIQk9BUkRfRE9DVU1FTlRBVElPTl9VUkwgZnJvbSAnLi9kb2N1bWVudGF0aW9uLXVybCc7XG5cbmNvbnN0IGRhc2hib2FyZENvbm5lY3RvciAgICAgPSBuZXcgRGFzaGJvYXJkQ29ubmVjdG9yKCk7XG5jb25zdCBkYXNoYm9hcmRDb25maWdTdG9yYWdlID0gbmV3IERhc2hib2FyZENvbmZpZ1N0b3JhZ2UoKTtcblxuYXN5bmMgZnVuY3Rpb24gcmVnaXN0ZXJJbkRhc2hib2FyZCAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaW5mbyhtZXNzYWdlcy5SRUdJU1RSQVRJT05fRU5URVJfRU1BSUxfSU5WSVRBVElPTik7XG5cbiAgICBjb25zdCB7IGVtYWlsIH0gPSBhd2FpdCBwcm9tcHRzKHtcbiAgICAgICAgdHlwZTogICAgICd0ZXh0JyxcbiAgICAgICAgbmFtZTogICAgICdlbWFpbCcsXG4gICAgICAgIG1lc3NhZ2U6ICBtZXNzYWdlcy5QUk9NUFRfRU1BSUxfQ0FQVElPTixcbiAgICAgICAgdmFsaWRhdGU6IChpbnB1dDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWVtYWlsVmFsaWRhdG9yLnZhbGlkYXRlKGlucHV0KSlcbiAgICAgICAgICAgICAgICByZXR1cm4gbWVzc2FnZXMuUFJPTVBUX0lOVkFMSURfRU1BSUw7XG5cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFlbWFpbCkge1xuICAgICAgICBlcnJvcihtZXNzYWdlcy5SRUdJU1RSQVRJT05fQ0FOQ0VMTEVEKTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgc2VuZEVtYWlsUmVzdWx0ID0gYXdhaXQgZGFzaGJvYXJkQ29ubmVjdG9yLnNlbmRFbWFpbChlbWFpbCk7XG5cbiAgICBpZiAoIXNlbmRFbWFpbFJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgIGNvbnN0IHNlbmRFbWFpbEVycm9yTWVzc2FnZSA9IHNlbmRFbWFpbFJlc3VsdC5pc0Rhc2hib2FyZEVycm9yXG4gICAgICAgICAgICA/IHNlbmRFbWFpbFJlc3VsdC5lcnJvck1lc3NhZ2VcbiAgICAgICAgICAgIDogbWVzc2FnZXMuUkVHSVNUUkFUSU9OX0VNQUlMX1NFTkRJTkdfTkVUV09SS19FUlJPUjtcblxuICAgICAgICBlcnJvcihzZW5kRW1haWxFcnJvck1lc3NhZ2UpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpbmZvKG1lc3NhZ2VzLlJFR0lTVFJBVElPTl9FTUFJTF9TRU5UKTtcblxuICAgIGNvbnN0IHsgdG9rZW4gfSA9IGF3YWl0IHByb21wdHMoe1xuICAgICAgICB0eXBlOiAgICAndGV4dCcsXG4gICAgICAgIG5hbWU6ICAgICd0b2tlbicsXG4gICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VzLlBST01QVF9UT0tFTl9DQVBUSU9OLFxuICAgIH0pO1xuXG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgICBlcnJvcihtZXNzYWdlcy5SRUdJU1RSQVRJT05fQ0FOQ0VMTEVEKTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IGF3YWl0IGRhc2hib2FyZENvbm5lY3Rvci52YWxpZGF0ZVRva2VuKHRva2VuKTtcblxuICAgIGlmICghdmFsaWRhdGlvblJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHRFcnJvck1lc3NhZ2UgPSB2YWxpZGF0aW9uUmVzdWx0LmlzRGFzaGJvYXJkRXJyb3JcbiAgICAgICAgICAgID8gdmFsaWRhdGlvblJlc3VsdC5lcnJvck1lc3NhZ2VcbiAgICAgICAgICAgIDogbWVzc2FnZXMuVE9LRU5fVkFMSURBVElPTl9ORVRXT1JLX0VSUk9SO1xuXG4gICAgICAgIGVycm9yKHZhbGlkYXRpb25SZXN1bHRFcnJvck1lc3NhZ2UpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBkYXNoYm9hcmRDb25maWdTdG9yYWdlLm9wdGlvbnMuc2VuZFJlcG9ydCA9IHRydWU7XG5cbiAgICBhd2FpdCBzYXZlTmV3VG9rZW4odG9rZW4pO1xuXG4gICAgc3VjY2VzcyhtZXNzYWdlcy5SRUdJU1RSQVRJT05fRklOSVNIRUQpO1xuXG4gICAgaW5mbyhcbiAgICAgICAgJ1ZpZXcgdGVzdCByZXN1bHRzIGF0OlxcbicgK1xuICAgICAgICBgJHtjaGFsay51bmRlcmxpbmUuYmx1ZUJyaWdodChnZXREZWZhdWx0UHJvamVjdExpbmsodG9rZW4pKX1gXG4gICAgKTtcblxuICAgIGluZm8oXG4gICAgICAgIGBSdW4gJHtjaGFsay5ibGFjay5iZ1doaXRlQnJpZ2h0KCd0ZXN0Y2FmZSBkYXNoYm9hcmQgb2ZmJyl9IHRvIGRpc2FibGUgdGhpcyBiZWhhdmlvci5gICtcbiAgICAgICAgYExlYXJuIG1vcmUgYXQ6XFxuJHtjaGFsay51bmRlcmxpbmUuYmx1ZUJyaWdodChEQVNIQk9BUkRfRE9DVU1FTlRBVElPTl9VUkwpfWBcbiAgICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzYXZlTmV3VG9rZW4gKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBkYXNoYm9hcmRDb25maWdTdG9yYWdlLm9wdGlvbnMudG9rZW4gPSB0b2tlbjtcblxuICAgIGF3YWl0IGRhc2hib2FyZENvbmZpZ1N0b3JhZ2Uuc2F2ZSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVEZWZhdWx0VG9rZW4gKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghZGFzaGJvYXJkQ29uZmlnU3RvcmFnZS5vcHRpb25zLnNlbmRSZXBvcnQpXG4gICAgICAgIHdhcm5pbmcobWVzc2FnZXMuVE9LRU5fVVBEQVRJTkdfTk9UX1NFTkRfUkVQT1JUKTtcblxuICAgIC8vIE5PVEU6IGZvciB0aGUgZm9ybWF0dGluZyByZWFzb25cbiAgICBpbmZvKCcnKTtcblxuICAgIGNvbnN0IHsgZG9Zb3VXYW50VG9VcGRhdGVEZWZhdWx0VG9rZW4gfSA9IGF3YWl0IHByb21wdHMoe1xuICAgICAgICB0eXBlOiAgICAnY29uZmlybScsXG4gICAgICAgIG5hbWU6ICAgICdkb1lvdVdhbnRUb1VwZGF0ZURlZmF1bHRUb2tlbicsXG4gICAgICAgIG1lc3NhZ2U6ICdZb3VyIHNldHVwIGluY2x1ZGVzIGEgZGVmYXVsdCBEYXNoYm9hcmQgdG9rZW4uIERvIHlvdSB3YW50IHRvIGNoYW5nZSBpdD86JyxcbiAgICB9KTtcblxuICAgIGlmICghZG9Zb3VXYW50VG9VcGRhdGVEZWZhdWx0VG9rZW4pIHtcbiAgICAgICAgZXJyb3IobWVzc2FnZXMuVE9LRU5fVVBEQVRFX0NBTkNFTExFRCk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIE5PVEU6IGZvciB0aGUgZm9ybWF0dGluZyByZWFzb25cbiAgICBpbmZvKCcnKTtcblxuICAgIGNvbnN0IHsgbmV3VG9rZW4gfSA9IGF3YWl0IHByb21wdHMoe1xuICAgICAgICB0eXBlOiAgICAndGV4dCcsXG4gICAgICAgIG5hbWU6ICAgICduZXdUb2tlbicsXG4gICAgICAgIG1lc3NhZ2U6ICdFbnRlciB0aGUgbmV3IGRlZmF1bHQgdG9rZW4gdmFsdWU6JyxcbiAgICB9KTtcblxuICAgIGlmICghbmV3VG9rZW4pIHtcbiAgICAgICAgZXJyb3IobWVzc2FnZXMuVE9LRU5fVVBEQVRFX0NBTkNFTExFRCk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBhd2FpdCBkYXNoYm9hcmRDb25uZWN0b3IudmFsaWRhdGVUb2tlbihuZXdUb2tlbik7XG5cbiAgICBpZiAoIXZhbGlkYXRpb25SZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0RXJyb3JNZXNzYWdlID0gdmFsaWRhdGlvblJlc3VsdC5pc0Rhc2hib2FyZEVycm9yXG4gICAgICAgICAgICA/IHZhbGlkYXRpb25SZXN1bHQuZXJyb3JNZXNzYWdlXG4gICAgICAgICAgICA6IG1lc3NhZ2VzLlRPS0VOX1ZBTElEQVRJT05fTkVUV09SS19FUlJPUjtcblxuICAgICAgICBlcnJvcih2YWxpZGF0aW9uUmVzdWx0RXJyb3JNZXNzYWdlKTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgYXdhaXQgc2F2ZU5ld1Rva2VuKG5ld1Rva2VuKTtcblxuICAgIHN1Y2Nlc3MobWVzc2FnZXMuVE9LRU5fVVBEQVRFRCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFNlbmRSZXBvcnRTdGF0ZSAoc3RhdGU6IFNlbmRSZXBvcnRTdGF0ZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNlbmRSZXBvcnRBc0Jvb2xlYW4gPSBzdGF0ZSA9PT0gJ29uJztcblxuICAgIGRhc2hib2FyZENvbmZpZ1N0b3JhZ2Uub3B0aW9ucy5zZW5kUmVwb3J0ID0gc2VuZFJlcG9ydEFzQm9vbGVhbjtcblxuICAgIGF3YWl0IGRhc2hib2FyZENvbmZpZ1N0b3JhZ2Uuc2F2ZSgpO1xuXG4gICAgY29uc3QgcmVzdWx0TWVzc2FnZSA9IHNlbmRSZXBvcnRBc0Jvb2xlYW4gPyBtZXNzYWdlcy5TRU5EX1JFUE9SVF9TVEFURV9PTiA6IG1lc3NhZ2VzLlNFTkRfUkVQT1JUX1NUQVRFX09GRjtcblxuICAgIHN1Y2Nlc3MocmVzdWx0TWVzc2FnZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRyeVRvUmVnaXN0ZXJJbkRhc2hib2FyZCAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaW5mbyhtZXNzYWdlcy5UT0tFTl9OT19ERUZBVUxUX0ZPVU5EKTtcblxuICAgIGNvbnN0IHsgbGF1bmNoQ29uZmlndXJhdGlvbldpemFyZCB9ID0gYXdhaXQgcHJvbXB0cyh7XG4gICAgICAgIHR5cGU6ICAgICdjb25maXJtJyxcbiAgICAgICAgbmFtZTogICAgJ2xhdW5jaENvbmZpZ3VyYXRpb25XaXphcmQnLFxuICAgICAgICBtZXNzYWdlOiAnRG8geW91IHdhbnQgdG8gbGF1bmNoIHRoZSBjb25maWd1cmF0aW9uIHdpemFyZD8nLFxuICAgICAgICBpbml0aWFsOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgaWYgKCFsYXVuY2hDb25maWd1cmF0aW9uV2l6YXJkKSB7XG4gICAgICAgIGVycm9yKG1lc3NhZ2VzLlJFR0lTVFJBVElPTl9DQU5DRUxMRUQpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBhd2FpdCByZWdpc3RlckluRGFzaGJvYXJkKCk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIChzZW5kUmVwb3J0U3RhdGU6IFNlbmRSZXBvcnRTdGF0ZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHN0b3JhZ2VFeGlzdHMgPSBhd2FpdCBkYXNoYm9hcmRDb25maWdTdG9yYWdlLmxvYWQoKTtcblxuICAgIGlmIChzZW5kUmVwb3J0U3RhdGUgIT09IHZvaWQgMCkge1xuICAgICAgICBpZiAoc3RvcmFnZUV4aXN0cylcbiAgICAgICAgICAgIGF3YWl0IHNldFNlbmRSZXBvcnRTdGF0ZShzZW5kUmVwb3J0U3RhdGUpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBhd2FpdCB0cnlUb1JlZ2lzdGVySW5EYXNoYm9hcmQoKTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdGhlcmVJc0RlZmF1bHRUb2tlbiA9ICEhZGFzaGJvYXJkQ29uZmlnU3RvcmFnZS5vcHRpb25zLnRva2VuO1xuXG4gICAgaWYgKHRoZXJlSXNEZWZhdWx0VG9rZW4pXG4gICAgICAgIGF3YWl0IHVwZGF0ZURlZmF1bHRUb2tlbigpO1xuICAgIGVsc2VcbiAgICAgICAgYXdhaXQgcmVnaXN0ZXJJbkRhc2hib2FyZCgpO1xufVxuIl19