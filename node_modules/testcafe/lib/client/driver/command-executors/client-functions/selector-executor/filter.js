"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../../../../shared/errors/index");
const utils_1 = require("./utils");
// @ts-ignore
const hammerhead_1 = require("../../../deps/hammerhead");
const SELECTOR_FILTER_ERROR = {
    filterVisible: 1,
    filterHidden: 2,
    nth: 3,
};
const FILTER_ERROR_TO_API_RE = {
    [SELECTOR_FILTER_ERROR.filterVisible]: /^\.filterVisible\(\)$/,
    [SELECTOR_FILTER_ERROR.filterHidden]: /^\.filterHidden\(\)$/,
    [SELECTOR_FILTER_ERROR.nth]: /^\.nth\(\d+\)$/,
};
class SelectorFilter {
    constructor() {
        this._err = null;
    }
    get error() {
        return this._err;
    }
    set error(message) {
        if (this._err === null)
            this._err = message;
    }
    filter(nodes, options, apiInfo) {
        if (options.filterVisible) {
            nodes = nodes.filter(utils_1.visible);
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterVisible);
        }
        if (options.filterHidden) {
            nodes = nodes.filter(n => !utils_1.visible(n));
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterHidden);
        }
        if (options.counterMode) {
            if (options.index === null)
                return nodes.length;
            return SelectorFilter._getNodeByIndex(nodes, options.index) ? 1 : 0;
        }
        if (options.collectionMode) {
            if (options.index !== null) {
                const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index);
                nodes = nodeOnIndex ? [nodeOnIndex] : [];
                this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.nth);
            }
            return nodes;
        }
        const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index || 0);
        if (!nodeOnIndex)
            this.error = SelectorFilter._getErrorItem(apiInfo, SELECTOR_FILTER_ERROR.nth);
        return nodeOnIndex;
    }
    cast(searchResult) {
        if (searchResult === null || searchResult === void 0)
            return [];
        else if (searchResult instanceof hammerhead_1.nativeMethods.Node)
            return [searchResult];
        else if (utils_1.isArrayOfNodes(searchResult))
            return searchResult;
        else if (utils_1.isNodeCollection(searchResult))
            return utils_1.castToArray(searchResult);
        throw new index_1.InvalidSelectorResultError();
    }
    _assertFilterError(filtered, apiInfo, filterError) {
        if (filtered.length === 0)
            this.error = SelectorFilter._getErrorItem(apiInfo, filterError);
    }
    static _getErrorItem({ apiFnChain, apiFnID }, err) {
        if (err) {
            for (let i = apiFnID; i < apiFnChain.length; i++) {
                if (FILTER_ERROR_TO_API_RE[err].test(apiFnChain[i]))
                    return i;
            }
        }
        return null;
    }
    static _getNodeByIndex(nodes, index) {
        return index < 0 ? nodes[nodes.length + index] : nodes[index];
    }
}
exports.default = new SelectorFilter();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9kcml2ZXIvY29tbWFuZC1leGVjdXRvcnMvY2xpZW50LWZ1bmN0aW9ucy9zZWxlY3Rvci1leGVjdXRvci9maWx0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4REFBZ0Y7QUFDaEYsbUNBS2lCO0FBRWpCLGFBQWE7QUFDYix5REFBeUQ7QUFHekQsTUFBTSxxQkFBcUIsR0FBRztJQUMxQixhQUFhLEVBQUUsQ0FBQztJQUNoQixZQUFZLEVBQUcsQ0FBQztJQUNoQixHQUFHLEVBQVksQ0FBQztDQUNuQixDQUFDO0FBRUYsTUFBTSxzQkFBc0IsR0FBRztJQUMzQixDQUFDLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxFQUFFLHVCQUF1QjtJQUM5RCxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxFQUFHLHNCQUFzQjtJQUM3RCxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxFQUFZLGdCQUFnQjtDQUMxRCxDQUFDO0FBR0YsTUFBTSxjQUFjO0lBQXBCO1FBQ1ksU0FBSSxHQUFrQixJQUFJLENBQUM7SUFzRnZDLENBQUM7SUFwRkcsSUFBVyxLQUFLO1FBQ1osT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxJQUFXLEtBQUssQ0FBRSxPQUFzQjtRQUNwQyxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssSUFBSTtZQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztJQUM1QixDQUFDO0lBRU0sTUFBTSxDQUFFLEtBQWEsRUFBRSxPQUFzQixFQUFFLE9BQWdCO1FBQ2xFLElBQUksT0FBTyxDQUFDLGFBQWEsRUFBRTtZQUN2QixLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxlQUFPLENBQUMsQ0FBQztZQUU5QixJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxxQkFB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QUFlLENBQUUsS0FBYSxFQUFFLEtBQWE7UUFDeEQsT0FBTyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2xFLENBQUM7Q0FDSjtBQUVELGtCQUFlLElBQUksY0FBYyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnZhbGlkU2VsZWN0b3JSZXN1bHRFcnJvciB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3NoYXJlZC9lcnJvcnMvaW5kZXgnO1xuaW1wb3J0IHtcbiAgICB2aXNpYmxlLFxuICAgIGlzTm9kZUNvbGxlY3Rpb24sXG4gICAgaXNBcnJheU9mTm9kZXMsXG4gICAgY2FzdFRvQXJyYXksXG59IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgQVBJSW5mbywgRmlsdGVyT3B0aW9ucyB9IGZyb20gJy4uL3R5cGVzJztcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCB7IG5hdGl2ZU1ldGhvZHMgfSBmcm9tICcuLi8uLi8uLi9kZXBzL2hhbW1lcmhlYWQnO1xuXG5cbmNvbnN0IFNFTEVDVE9SX0ZJTFRFUl9FUlJPUiA9IHtcbiAgICBmaWx0ZXJWaXNpYmxlOiAxLFxuICAgIGZpbHRlckhpZGRlbjogIDIsXG4gICAgbnRoOiAgICAgICAgICAgMyxcbn07XG5cbmNvbnN0IEZJTFRFUl9FUlJPUl9UT19BUElfUkUgPSB7XG4gICAgW1NFTEVDVE9SX0ZJTFRFUl9FUlJPUi5maWx0ZXJWaXNpYmxlXTogL15cXC5maWx0ZXJWaXNpYmxlXFwoXFwpJC8sXG4gICAgW1NFTEVDVE9SX0ZJTFRFUl9FUlJPUi5maWx0ZXJIaWRkZW5dOiAgL15cXC5maWx0ZXJIaWRkZW5cXChcXCkkLyxcbiAgICBbU0VMRUNUT1JfRklMVEVSX0VSUk9SLm50aF06ICAgICAgICAgICAvXlxcLm50aFxcKFxcZCtcXCkkLyxcbn07XG5cblxuY2xhc3MgU2VsZWN0b3JGaWx0ZXIge1xuICAgIHByaXZhdGUgX2VycjogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5cbiAgICBwdWJsaWMgZ2V0IGVycm9yICgpOiBudW1iZXIgfCBudWxsIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VycjtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IGVycm9yIChtZXNzYWdlOiBudW1iZXIgfCBudWxsKSB7XG4gICAgICAgIGlmICh0aGlzLl9lcnIgPT09IG51bGwpXG4gICAgICAgICAgICB0aGlzLl9lcnIgPSBtZXNzYWdlO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaWx0ZXIgKG5vZGVzOiBOb2RlW10sIG9wdGlvbnM6IEZpbHRlck9wdGlvbnMsIGFwaUluZm86IEFQSUluZm8pOiBudW1iZXIgfCBOb2RlIHwgTm9kZVtdIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuZmlsdGVyVmlzaWJsZSkge1xuICAgICAgICAgICAgbm9kZXMgPSBub2Rlcy5maWx0ZXIodmlzaWJsZSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2Fzc2VydEZpbHRlckVycm9yKG5vZGVzLCBhcGlJbmZvLCBTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVyVmlzaWJsZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy5maWx0ZXJIaWRkZW4pIHtcbiAgICAgICAgICAgIG5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gIXZpc2libGUobikpO1xuXG4gICAgICAgICAgICB0aGlzLl9hc3NlcnRGaWx0ZXJFcnJvcihub2RlcywgYXBpSW5mbywgU0VMRUNUT1JfRklMVEVSX0VSUk9SLmZpbHRlckhpZGRlbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy5jb3VudGVyTW9kZSkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5kZXggPT09IG51bGwpXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVzLmxlbmd0aDtcblxuICAgICAgICAgICAgcmV0dXJuIFNlbGVjdG9yRmlsdGVyLl9nZXROb2RlQnlJbmRleChub2Rlcywgb3B0aW9ucy5pbmRleCkgPyAxIDogMDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb25Nb2RlKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5pbmRleCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGVPbkluZGV4ID0gU2VsZWN0b3JGaWx0ZXIuX2dldE5vZGVCeUluZGV4KG5vZGVzLCBvcHRpb25zLmluZGV4KTtcblxuICAgICAgICAgICAgICAgIG5vZGVzID0gbm9kZU9uSW5kZXggPyBbbm9kZU9uSW5kZXhdIDogW107XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9hc3NlcnRGaWx0ZXJFcnJvcihub2RlcywgYXBpSW5mbywgU0VMRUNUT1JfRklMVEVSX0VSUk9SLm50aCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBub2RlcztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5vZGVPbkluZGV4ID0gU2VsZWN0b3JGaWx0ZXIuX2dldE5vZGVCeUluZGV4KG5vZGVzLCBvcHRpb25zLmluZGV4IHx8IDApO1xuXG4gICAgICAgIGlmICghbm9kZU9uSW5kZXgpXG4gICAgICAgICAgICB0aGlzLmVycm9yID0gU2VsZWN0b3JGaWx0ZXIuX2dldEVycm9ySXRlbShhcGlJbmZvLCBTRUxFQ1RPUl9GSUxURVJfRVJST1IubnRoKTtcblxuICAgICAgICByZXR1cm4gbm9kZU9uSW5kZXg7XG4gICAgfVxuXG4gICAgcHVibGljIGNhc3QgKHNlYXJjaFJlc3VsdDogdW5rbm93bik6IE5vZGVbXSB7XG4gICAgICAgIGlmIChzZWFyY2hSZXN1bHQgPT09IG51bGwgfHwgc2VhcmNoUmVzdWx0ID09PSB2b2lkIDApXG4gICAgICAgICAgICByZXR1cm4gW107XG5cbiAgICAgICAgZWxzZSBpZiAoc2VhcmNoUmVzdWx0IGluc3RhbmNlb2YgbmF0aXZlTWV0aG9kcy5Ob2RlKVxuICAgICAgICAgICAgcmV0dXJuIFtzZWFyY2hSZXN1bHQgYXMgTm9kZV07XG5cbiAgICAgICAgZWxzZSBpZiAoaXNBcnJheU9mTm9kZXMoc2VhcmNoUmVzdWx0KSlcbiAgICAgICAgICAgIHJldHVybiBzZWFyY2hSZXN1bHQ7XG5cbiAgICAgICAgZWxzZSBpZiAoaXNOb2RlQ29sbGVjdGlvbihzZWFyY2hSZXN1bHQpKVxuICAgICAgICAgICAgcmV0dXJuIGNhc3RUb0FycmF5KHNlYXJjaFJlc3VsdCk7XG5cbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRTZWxlY3RvclJlc3VsdEVycm9yKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYXNzZXJ0RmlsdGVyRXJyb3IgKGZpbHRlcmVkOiBOb2RlW10sIGFwaUluZm86IEFQSUluZm8sIGZpbHRlckVycm9yOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgaWYgKGZpbHRlcmVkLmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBTZWxlY3RvckZpbHRlci5fZ2V0RXJyb3JJdGVtKGFwaUluZm8sIGZpbHRlckVycm9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfZ2V0RXJyb3JJdGVtICh7IGFwaUZuQ2hhaW4sIGFwaUZuSUQgfTogQVBJSW5mbywgZXJyOiBudW1iZXIpOiBudW1iZXIgfCBudWxsIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IGFwaUZuSUQ7IGkgPCBhcGlGbkNoYWluLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKEZJTFRFUl9FUlJPUl9UT19BUElfUkVbZXJyXS50ZXN0KGFwaUZuQ2hhaW5baV0pKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9nZXROb2RlQnlJbmRleCAobm9kZXM6IE5vZGVbXSwgaW5kZXg6IG51bWJlcik6IE5vZGUgfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gaW5kZXggPCAwID8gbm9kZXNbbm9kZXMubGVuZ3RoICsgaW5kZXhdIDogbm9kZXNbaW5kZXhdO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IFNlbGVjdG9yRmlsdGVyKCk7XG4iXX0=