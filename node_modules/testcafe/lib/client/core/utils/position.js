"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isElementVisible = exports.isIframeVisible = exports.getWindowPosition = exports.isInRectangle = exports.getClientPosition = exports.findCenter = exports.getIframePointRelativeToParentFrame = exports.getEventPageCoordinates = exports.getEventAbsoluteCoordinates = exports.containsOffset = exports.getIframeClientCoordinates = exports.calcRelativePosition = exports.getElementFromPoint = exports.getClientDimensions = exports.offsetToClientCoords = exports.getOffsetPosition = exports.getElementRectangle = void 0;
const hammerhead_1 = __importDefault(require("../deps/hammerhead"));
const styleUtils = __importStar(require("./style"));
const domUtils = __importStar(require("./dom"));
const axis_values_1 = __importDefault(require("./values/axis-values"));
const boundary_values_1 = __importDefault(require("./values/boundary-values"));
const dimensions_1 = __importDefault(require("./values/dimensions"));
exports.getElementRectangle = hammerhead_1.default.utils.position.getElementRectangle;
exports.getOffsetPosition = hammerhead_1.default.utils.position.getOffsetPosition;
exports.offsetToClientCoords = hammerhead_1.default.utils.position.offsetToClientCoords;
function getClientDimensions(target) {
    const isHtmlElement = domUtils.isHtmlElement(target);
    const body = isHtmlElement ? target.getElementsByTagName('body')[0] : null;
    const elementRect = target.getBoundingClientRect();
    const elBorders = boundary_values_1.default.create(styleUtils.getBordersWidth(target));
    const elScroll = styleUtils.getElementScroll(target);
    const isElementInIframe = domUtils.isElementInIframe(target);
    const isCompatMode = target.ownerDocument.compatMode === 'BackCompat';
    const elPosition = isHtmlElement ? new axis_values_1.default(0, 0) : axis_values_1.default.create(elementRect);
    let elHeight = elementRect.height;
    let elWidth = elementRect.width;
    if (isHtmlElement) {
        if (body && isCompatMode) {
            elHeight = body.clientHeight;
            elWidth = body.clientWidth;
        }
        else {
            elHeight = target.clientHeight;
            elWidth = target.clientWidth;
        }
    }
    if (isElementInIframe) {
        const iframeElement = domUtils.getIframeByElement(target);
        if (iframeElement) {
            const iframeOffset = exports.getOffsetPosition(iframeElement);
            const clientOffset = exports.offsetToClientCoords(axis_values_1.default.create(iframeOffset));
            const iframeBorders = styleUtils.getBordersWidth(iframeElement);
            elPosition.add(clientOffset).add(axis_values_1.default.create(iframeBorders));
            if (isHtmlElement)
                elBorders.add(iframeBorders);
        }
    }
    const hasRightScrollbar = !isHtmlElement && styleUtils.getInnerWidth(target) !== target.clientWidth;
    const hasBottomScrollbar = !isHtmlElement && styleUtils.getInnerHeight(target) !== target.clientHeight;
    const scrollbar = {
        right: hasRightScrollbar ? domUtils.getScrollbarSize() : 0,
        bottom: hasBottomScrollbar ? domUtils.getScrollbarSize() : 0,
    };
    return new dimensions_1.default(elWidth, elHeight, elPosition, elBorders, elScroll, scrollbar);
}
exports.getClientDimensions = getClientDimensions;
function getElementFromPoint({ x, y }) {
    // @ts-ignore
    const ieFn = document.getElementFromPoint;
    const func = ieFn || document.elementFromPoint;
    let el = null;
    try {
        // Permission denied to access property 'getElementFromPoint' error in iframe
        el = func.call(document, x, y);
    }
    catch (_a) {
        return null;
    }
    //NOTE: elementFromPoint returns null when is's a border of an iframe
    if (el === null)
        el = func.call(document, x - 1, y - 1);
    while (el && el.shadowRoot && el.shadowRoot.elementFromPoint) {
        const shadowEl = el.shadowRoot.elementFromPoint(x, y);
        if (!shadowEl || el === shadowEl)
            break;
        el = shadowEl;
    }
    return el;
}
exports.getElementFromPoint = getElementFromPoint;
function calcRelativePosition(dimensions, toDimensions) {
    const pos = boundary_values_1.default.create({
        top: dimensions.top - toDimensions.top,
        left: dimensions.left - toDimensions.left,
        right: toDimensions.right - dimensions.right,
        bottom: toDimensions.bottom - dimensions.bottom,
    });
    return pos.sub(toDimensions.border).sub(toDimensions.scrollbar).round(Math.ceil, Math.floor);
}
exports.calcRelativePosition = calcRelativePosition;
function getIframeClientCoordinates(iframe) {
    const { left, top } = exports.getOffsetPosition(iframe);
    const clientPosition = exports.offsetToClientCoords({ x: left, y: top });
    const iframeBorders = styleUtils.getBordersWidth(iframe);
    const iframePadding = styleUtils.getElementPadding(iframe);
    const iframeRectangleLeft = clientPosition.x + iframeBorders.left + iframePadding.left;
    const iframeRectangleTop = clientPosition.y + iframeBorders.top + iframePadding.top;
    return new boundary_values_1.default(iframeRectangleTop, iframeRectangleLeft + styleUtils.getWidth(iframe), iframeRectangleTop + styleUtils.getHeight(iframe), iframeRectangleLeft);
}
exports.getIframeClientCoordinates = getIframeClientCoordinates;
function containsOffset(el, offsetX, offsetY) {
    const dimensions = getClientDimensions(el);
    const width = Math.max(el.scrollWidth, dimensions.width);
    const height = Math.max(el.scrollHeight, dimensions.height);
    const maxX = dimensions.scrollbar.right + dimensions.border.left + dimensions.border.right + width;
    const maxY = dimensions.scrollbar.bottom + dimensions.border.top + dimensions.border.bottom + height;
    return (typeof offsetX === 'undefined' || offsetX >= 0 && maxX >= offsetX) &&
        (typeof offsetY === 'undefined' || offsetY >= 0 && maxY >= offsetY);
}
exports.containsOffset = containsOffset;
function getEventAbsoluteCoordinates(ev) {
    const el = ev.target || ev.srcElement;
    const pageCoordinates = getEventPageCoordinates(ev);
    const curDocument = domUtils.findDocument(el);
    let xOffset = 0;
    let yOffset = 0;
    if (domUtils.isElementInIframe(curDocument.documentElement)) {
        const currentIframe = domUtils.getIframeByElement(curDocument);
        if (currentIframe) {
            const iframeOffset = exports.getOffsetPosition(currentIframe);
            const iframeBorders = styleUtils.getBordersWidth(currentIframe);
            xOffset = iframeOffset.left + iframeBorders.left;
            yOffset = iframeOffset.top + iframeBorders.top;
        }
    }
    return new axis_values_1.default(pageCoordinates.x + xOffset, pageCoordinates.y + yOffset);
}
exports.getEventAbsoluteCoordinates = getEventAbsoluteCoordinates;
function getEventPageCoordinates(ev) {
    const curCoordObject = /^touch/.test(ev.type) && ev.targetTouches ? ev.targetTouches[0] || ev.changedTouches[0] : ev;
    const bothPageCoordinatesAreZero = curCoordObject.pageX === 0 && curCoordObject.pageY === 0;
    const notBothClientCoordinatesAreZero = curCoordObject.clientX !== 0 || curCoordObject.clientY !== 0;
    if ((curCoordObject.pageX === null || bothPageCoordinatesAreZero && notBothClientCoordinatesAreZero) &&
        curCoordObject.clientX !== null) {
        const currentDocument = domUtils.findDocument(ev.target || ev.srcElement);
        const html = currentDocument.documentElement;
        const body = currentDocument.body;
        return new axis_values_1.default(Math.round(curCoordObject.clientX + (html && html.scrollLeft || body && body.scrollLeft || 0) -
            (html.clientLeft || 0)), Math.round(curCoordObject.clientY + (html && html.scrollTop || body && body.scrollTop || 0) -
            (html.clientTop || 0)));
    }
    return new axis_values_1.default(Math.round(curCoordObject.pageX), Math.round(curCoordObject.pageY));
}
exports.getEventPageCoordinates = getEventPageCoordinates;
function getIframePointRelativeToParentFrame(pos, iframeWin) {
    const iframe = domUtils.findIframeByWindow(iframeWin);
    const iframeOffset = exports.getOffsetPosition(iframe);
    const iframeBorders = styleUtils.getBordersWidth(iframe);
    const iframePadding = styleUtils.getElementPadding(iframe);
    return exports.offsetToClientCoords({
        x: pos.x + iframeOffset.left + iframeBorders.left + iframePadding.left,
        y: pos.y + iframeOffset.top + iframeBorders.top + iframePadding.top,
    });
}
exports.getIframePointRelativeToParentFrame = getIframePointRelativeToParentFrame;
function findCenter(el) {
    const rectangle = exports.getElementRectangle(el);
    return new axis_values_1.default(Math.round(rectangle.left + rectangle.width / 2), Math.round(rectangle.top + rectangle.height / 2));
}
exports.findCenter = findCenter;
function getClientPosition(el) {
    const { left, top } = exports.getOffsetPosition(el);
    const clientCoords = exports.offsetToClientCoords({ x: left, y: top });
    clientCoords.x = Math.round(clientCoords.x);
    clientCoords.y = Math.round(clientCoords.y);
    return clientCoords;
}
exports.getClientPosition = getClientPosition;
function isInRectangle({ x, y }, rectangle) {
    return x >= rectangle.left && x <= rectangle.right && y >= rectangle.top && y <= rectangle.bottom;
}
exports.isInRectangle = isInRectangle;
function getWindowPosition() {
    const x = window.screenLeft || window.screenX;
    const y = window.screenTop || window.screenY;
    return new axis_values_1.default(x, y);
}
exports.getWindowPosition = getWindowPosition;
function isIframeVisible(el) {
    return !hiddenUsingStyles(el);
}
exports.isIframeVisible = isIframeVisible;
function hiddenUsingStyles(el) {
    return styleUtils.get(el, 'visibility') === 'hidden' ||
        styleUtils.get(el, 'display') === 'none';
}
function hiddenByRectangle(el) {
    const elementRectangle = exports.getElementRectangle(el);
    return elementRectangle.width === 0 ||
        elementRectangle.height === 0;
}
function isElementVisible(el) {
    if (domUtils.isTextNode(el))
        return !styleUtils.isNotVisibleNode(el);
    if (!domUtils.isContentEditableElement(el) &&
        !domUtils.isSVGElement(el) &&
        hiddenByRectangle(el))
        return false;
    if (domUtils.isMapElement(el)) {
        const mapContainer = domUtils.getMapContainer(domUtils.closest(el, 'map'));
        return mapContainer ? isElementVisible(mapContainer) : false;
    }
    if (styleUtils.isSelectVisibleChild(el)) {
        const select = domUtils.getSelectParent(el);
        const childRealIndex = domUtils.getChildVisibleIndex(select, el);
        const realSelectSizeValue = styleUtils.getSelectElementSize(select);
        const topVisibleIndex = Math.max(styleUtils.getScrollTop(select) / styleUtils.getOptionHeight(select), 0);
        const bottomVisibleIndex = topVisibleIndex + realSelectSizeValue - 1;
        const optionVisibleIndex = Math.max(childRealIndex - topVisibleIndex, 0);
        return optionVisibleIndex >= topVisibleIndex && optionVisibleIndex <= bottomVisibleIndex;
    }
    if (domUtils.isSVGElement(el)) {
        const hiddenParent = domUtils.findParent(el, true, (parent) => {
            return hiddenUsingStyles(parent);
        });
        if (!hiddenParent)
            return !hiddenByRectangle(el);
        return false;
    }
    return styleUtils.hasDimensions(el) && !hiddenUsingStyles(el);
}
exports.isElementVisible = isElementVisible;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zaXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L2NvcmUvdXRpbHMvcG9zaXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG9FQUE0QztBQUM1QyxvREFBc0M7QUFDdEMsZ0RBQWtDO0FBQ2xDLHVFQUFrRTtBQUNsRSwrRUFBOEU7QUFDOUUscUVBQTZDO0FBR2hDLFFBQUEsbUJBQW1CLEdBQUksb0JBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDO0FBQ3JFLFFBQUEsaUJBQWlCLEdBQU0sb0JBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDO0FBQ25FLFFBQUEsb0JBQW9CLEdBQUcsb0JBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDO0FBRW5GLFNBQWdCLG1CQUFtQixDQUFFLE1BQW1CO0lBQ3BELE1BQU0sYUFBYSxHQUFPLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDekQsTUFBTSxJQUFJLEdBQWdCLGFBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDeEYsTUFBTSxXQUFXLEdBQVMsTUFBTSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDekQsTUFBTSxTQUFTLEdBQVcseUJBQWMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLE1BQU0sUUFBUSxHQUFZLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5RCxNQUFNLGlCQUFpQixHQUFHLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3RCxNQUFNLFlBQVksR0FB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QU8saUJBQWlCLENBQUMsTUFBZ0MsQ0FBQyxDQUFDO1FBQy9ELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFlBQVk7WUFDYixPQUFPLENBQUMsaUJBQWlCLENBQUMsRUFBNEIsQ0FBQyxDQUFDO1FBRTVELE9BQU8sS0FBSyxDQUFDO0tBQ2hCO0lBRUQsT0FBTyxVQUFVLENBQUMsYUFBYSxDQUFDLEVBQWlCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQTRCLENBQUMsQ0FBQztBQUMzRyxDQUFDO0FBdENELDRDQXNDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBoYW1tZXJoZWFkIGZyb20gJy4uL2RlcHMvaGFtbWVyaGVhZCc7XG5pbXBvcnQgKiBhcyBzdHlsZVV0aWxzIGZyb20gJy4vc3R5bGUnO1xuaW1wb3J0ICogYXMgZG9tVXRpbHMgZnJvbSAnLi9kb20nO1xuaW1wb3J0IEF4aXNWYWx1ZXMsIHsgQXhpc1ZhbHVlc0RhdGEgfSBmcm9tICcuL3ZhbHVlcy9heGlzLXZhbHVlcyc7XG5pbXBvcnQgQm91bmRhcnlWYWx1ZXMsIHsgQm91bmRhcnlWYWx1ZXNEYXRhIH0gZnJvbSAnLi92YWx1ZXMvYm91bmRhcnktdmFsdWVzJztcbmltcG9ydCBEaW1lbnNpb25zIGZyb20gJy4vdmFsdWVzL2RpbWVuc2lvbnMnO1xuXG5cbmV4cG9ydCBjb25zdCBnZXRFbGVtZW50UmVjdGFuZ2xlICA9IGhhbW1lcmhlYWQudXRpbHMucG9zaXRpb24uZ2V0RWxlbWVudFJlY3RhbmdsZTtcbmV4cG9ydCBjb25zdCBnZXRPZmZzZXRQb3NpdGlvbiAgICA9IGhhbW1lcmhlYWQudXRpbHMucG9zaXRpb24uZ2V0T2Zmc2V0UG9zaXRpb247XG5leHBvcnQgY29uc3Qgb2Zmc2V0VG9DbGllbnRDb29yZHMgPSBoYW1tZXJoZWFkLnV0aWxzLnBvc2l0aW9uLm9mZnNldFRvQ2xpZW50Q29vcmRzO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2xpZW50RGltZW5zaW9ucyAodGFyZ2V0OiBIVE1MRWxlbWVudCk6IERpbWVuc2lvbnMge1xuICAgIGNvbnN0IGlzSHRtbEVsZW1lbnQgICAgID0gZG9tVXRpbHMuaXNIdG1sRWxlbWVudCh0YXJnZXQpO1xuICAgIGNvbnN0IGJvZHkgICAgICAgICAgICAgID0gaXNIdG1sRWxlbWVudCA/IHRhcmdldC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdIDogbnVsbDtcbiAgICBjb25zdCBlbGVtZW50UmVjdCAgICAgICA9IHRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBlbEJvcmRlcnMgICAgICAgICA9IEJvdW5kYXJ5VmFsdWVzLmNyZWF0ZShzdHlsZVV0aWxzLmdldEJvcmRlcnNXaWR0aCh0YXJnZXQpKTtcbiAgICBjb25zdCBlbFNjcm9sbCAgICAgICAgICA9IHN0eWxlVXRpbHMuZ2V0RWxlbWVudFNjcm9sbCh0YXJnZXQpO1xuICAgIGNvbnN0IGlzRWxlbWVudEluSWZyYW1lID0gZG9tVXRpbHMuaXNFbGVtZW50SW5JZnJhbWUodGFyZ2V0KTtcbiAgICBjb25zdCBpc0NvbXBhdE1vZGUgICAgICA9IHRhcmdldC5vd25lckRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICdCYWNrQ29tcGF0JztcbiAgICBjb25zdCBlbFBvc2l0aW9uICAgICAgICA9IGlzSHRtbEVsZW1lbnQgPyBuZXcgQXhpc1ZhbHVlcygwLCAwKSA6IEF4aXNWYWx1ZXMuY3JlYXRlKGVsZW1lbnRSZWN0KTtcblxuICAgIGxldCBlbEhlaWdodCAgID0gZWxlbWVudFJlY3QuaGVpZ2h0O1xuICAgIGxldCBlbFdpZHRoICAgID0gZWxlbWVudFJlY3Qud2lkdGg7XG5cbiAgICBpZiAoaXNIdG1sRWxlbWVudCkge1xuICAgICAgICBpZiAoYm9keSAmJiBpc0NvbXBhdE1vZGUpIHtcbiAgICAgICAgICAgIGVsSGVpZ2h0ID0gYm9keS5jbGllbnRIZWlnaHQ7XG4gICAgICAgICAgICBlbFdpZHRoICA9IGJvZHkuY2xpZW50V2lkdGg7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBlbEhlaWdodCA9IHRhcmdldC5jbGllbnRIZWlnaHQ7XG4gICAgICAgICAgICBlbFdpZHRoICA9IHRhcmdldC5jbGllbnRXaWR0aDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChpc0VsZW1lbnRJbklmcmFtZSkge1xuICAgICAgICBjb25zdCBpZnJhbWVFbGVtZW50ID0gZG9tVXRpbHMuZ2V0SWZyYW1lQnlFbGVtZW50KHRhcmdldCk7XG5cbiAgICAgICAgaWYgKGlmcmFtZUVsZW1lbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IGlmcmFtZU9mZnNldCAgPSBnZXRPZmZzZXRQb3NpdGlvbihpZnJhbWVFbGVtZW50KTtcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudE9mZnNldCAgPSBvZmZzZXRUb0NsaWVudENvb3JkcyhBeGlzVmFsdWVzLmNyZWF0ZShpZnJhbWVPZmZzZXQpKTtcbiAgICAgICAgICAgIGNvbnN0IGlmcmFtZUJvcmRlcnMgPSBzdHlsZVV0aWxzLmdldEJvcmRlcnNXaWR0aChpZnJhbWVFbGVtZW50KTtcblxuICAgICAgICAgICAgZWxQb3NpdGlvbi5hZGQoY2xpZW50T2Zmc2V0KS5hZGQoQXhpc1ZhbHVlcy5jcmVhdGUoaWZyYW1lQm9yZGVycykpO1xuXG4gICAgICAgICAgICBpZiAoaXNIdG1sRWxlbWVudClcbiAgICAgICAgICAgICAgICBlbEJvcmRlcnMuYWRkKGlmcmFtZUJvcmRlcnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgaGFzUmlnaHRTY3JvbGxiYXIgID0gIWlzSHRtbEVsZW1lbnQgJiYgc3R5bGVVdGlscy5nZXRJbm5lcldpZHRoKHRhcmdldCkgIT09IHRhcmdldC5jbGllbnRXaWR0aDtcbiAgICBjb25zdCBoYXNCb3R0b21TY3JvbGxiYXIgPSAhaXNIdG1sRWxlbWVudCAmJiBzdHlsZVV0aWxzLmdldElubmVySGVpZ2h0KHRhcmdldCkgIT09IHRhcmdldC5jbGllbnRIZWlnaHQ7XG5cbiAgICBjb25zdCBzY3JvbGxiYXIgPSB7XG4gICAgICAgIHJpZ2h0OiAgaGFzUmlnaHRTY3JvbGxiYXIgPyBkb21VdGlscy5nZXRTY3JvbGxiYXJTaXplKCkgOiAwLFxuICAgICAgICBib3R0b206IGhhc0JvdHRvbVNjcm9sbGJhciA/IGRvbVV0aWxzLmdldFNjcm9sbGJhclNpemUoKSA6IDAsXG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgRGltZW5zaW9ucyhlbFdpZHRoLCBlbEhlaWdodCwgZWxQb3NpdGlvbiwgZWxCb3JkZXJzLCBlbFNjcm9sbCwgc2Nyb2xsYmFyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVsZW1lbnRGcm9tUG9pbnQgKHsgeCwgeSB9OiBBeGlzVmFsdWVzRGF0YTxudW1iZXI+KTogRWxlbWVudCB8IG51bGwge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBpZUZuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEZyb21Qb2ludDtcbiAgICBjb25zdCBmdW5jID0gaWVGbiB8fCBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50O1xuXG4gICAgbGV0IGVsOiBFbGVtZW50IHwgbnVsbCA9IG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgICAvLyBQZXJtaXNzaW9uIGRlbmllZCB0byBhY2Nlc3MgcHJvcGVydHkgJ2dldEVsZW1lbnRGcm9tUG9pbnQnIGVycm9yIGluIGlmcmFtZVxuICAgICAgICBlbCA9IGZ1bmMuY2FsbChkb2N1bWVudCwgeCwgeSk7XG4gICAgfVxuICAgIGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy9OT1RFOiBlbGVtZW50RnJvbVBvaW50IHJldHVybnMgbnVsbCB3aGVuIGlzJ3MgYSBib3JkZXIgb2YgYW4gaWZyYW1lXG4gICAgaWYgKGVsID09PSBudWxsKVxuICAgICAgICBlbCA9IGZ1bmMuY2FsbChkb2N1bWVudCwgeCAtIDEsIHkgLSAxKTtcblxuICAgIHdoaWxlIChlbCAmJiBlbC5zaGFkb3dSb290ICYmIGVsLnNoYWRvd1Jvb3QuZWxlbWVudEZyb21Qb2ludCkge1xuICAgICAgICBjb25zdCBzaGFkb3dFbCA9IGVsLnNoYWRvd1Jvb3QuZWxlbWVudEZyb21Qb2ludCh4LCB5KTtcblxuICAgICAgICBpZiAoIXNoYWRvd0VsIHx8IGVsID09PSBzaGFkb3dFbClcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGVsID0gc2hhZG93RWw7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsY1JlbGF0aXZlUG9zaXRpb24gKGRpbWVuc2lvbnM6IERpbWVuc2lvbnMsIHRvRGltZW5zaW9uczogRGltZW5zaW9ucyk6IEJvdW5kYXJ5VmFsdWVzRGF0YSB7XG4gICAgY29uc3QgcG9zID0gQm91bmRhcnlWYWx1ZXMuY3JlYXRlKHtcbiAgICAgICAgdG9wOiAgICBkaW1lbnNpb25zLnRvcCAtIHRvRGltZW5zaW9ucy50b3AsXG4gICAgICAgIGxlZnQ6ICAgZGltZW5zaW9ucy5sZWZ0IC0gdG9EaW1lbnNpb25zLmxlZnQsXG4gICAgICAgIHJpZ2h0OiAgdG9EaW1lbnNpb25zLnJpZ2h0IC0gZGltZW5zaW9ucy5yaWdodCxcbiAgICAgICAgYm90dG9tOiB0b0RpbWVuc2lvbnMuYm90dG9tIC0gZGltZW5zaW9ucy5ib3R0b20sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcG9zLnN1Yih0b0RpbWVuc2lvbnMuYm9yZGVyKS5zdWIodG9EaW1lbnNpb25zLnNjcm9sbGJhcikucm91bmQoTWF0aC5jZWlsLCBNYXRoLmZsb29yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldElmcmFtZUNsaWVudENvb3JkaW5hdGVzIChpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50KTogQm91bmRhcnlWYWx1ZXMge1xuICAgIGNvbnN0IHsgbGVmdCwgdG9wIH0gICAgICAgPSBnZXRPZmZzZXRQb3NpdGlvbihpZnJhbWUpO1xuICAgIGNvbnN0IGNsaWVudFBvc2l0aW9uICAgICAgPSBvZmZzZXRUb0NsaWVudENvb3Jkcyh7IHg6IGxlZnQsIHk6IHRvcCB9KTtcbiAgICBjb25zdCBpZnJhbWVCb3JkZXJzICAgICAgID0gc3R5bGVVdGlscy5nZXRCb3JkZXJzV2lkdGgoaWZyYW1lKTtcbiAgICBjb25zdCBpZnJhbWVQYWRkaW5nICAgICAgID0gc3R5bGVVdGlscy5nZXRFbGVtZW50UGFkZGluZyhpZnJhbWUpO1xuICAgIGNvbnN0IGlmcmFtZVJlY3RhbmdsZUxlZnQgPSBjbGllbnRQb3NpdGlvbi54ICsgaWZyYW1lQm9yZGVycy5sZWZ0ICsgaWZyYW1lUGFkZGluZy5sZWZ0O1xuICAgIGNvbnN0IGlmcmFtZVJlY3RhbmdsZVRvcCAgPSBjbGllbnRQb3NpdGlvbi55ICsgaWZyYW1lQm9yZGVycy50b3AgKyBpZnJhbWVQYWRkaW5nLnRvcDtcblxuICAgIHJldHVybiBuZXcgQm91bmRhcnlWYWx1ZXMoaWZyYW1lUmVjdGFuZ2xlVG9wLFxuICAgICAgICBpZnJhbWVSZWN0YW5nbGVMZWZ0ICsgc3R5bGVVdGlscy5nZXRXaWR0aChpZnJhbWUpLFxuICAgICAgICBpZnJhbWVSZWN0YW5nbGVUb3AgKyBzdHlsZVV0aWxzLmdldEhlaWdodChpZnJhbWUpLFxuICAgICAgICBpZnJhbWVSZWN0YW5nbGVMZWZ0KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnRhaW5zT2Zmc2V0IChlbDogSFRNTEVsZW1lbnQsIG9mZnNldFg/OiBudW1iZXIsIG9mZnNldFk/OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCBkaW1lbnNpb25zID0gZ2V0Q2xpZW50RGltZW5zaW9ucyhlbCk7XG4gICAgY29uc3Qgd2lkdGggICAgICA9IE1hdGgubWF4KGVsLnNjcm9sbFdpZHRoLCBkaW1lbnNpb25zLndpZHRoKTtcbiAgICBjb25zdCBoZWlnaHQgICAgID0gTWF0aC5tYXgoZWwuc2Nyb2xsSGVpZ2h0LCBkaW1lbnNpb25zLmhlaWdodCk7XG4gICAgY29uc3QgbWF4WCAgICAgICA9IGRpbWVuc2lvbnMuc2Nyb2xsYmFyLnJpZ2h0ICsgZGltZW5zaW9ucy5ib3JkZXIubGVmdCArIGRpbWVuc2lvbnMuYm9yZGVyLnJpZ2h0ICsgd2lkdGg7XG4gICAgY29uc3QgbWF4WSAgICAgICA9IGRpbWVuc2lvbnMuc2Nyb2xsYmFyLmJvdHRvbSArIGRpbWVuc2lvbnMuYm9yZGVyLnRvcCArIGRpbWVuc2lvbnMuYm9yZGVyLmJvdHRvbSArIGhlaWdodDtcblxuICAgIHJldHVybiAodHlwZW9mIG9mZnNldFggPT09ICd1bmRlZmluZWQnIHx8IG9mZnNldFggPj0gMCAmJiBtYXhYID49IG9mZnNldFgpICYmXG4gICAgICAgICAgICh0eXBlb2Ygb2Zmc2V0WSA9PT0gJ3VuZGVmaW5lZCcgfHwgb2Zmc2V0WSA+PSAwICYmIG1heFkgPj0gb2Zmc2V0WSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFdmVudEFic29sdXRlQ29vcmRpbmF0ZXMgKGV2OiBNb3VzZUV2ZW50KTogQXhpc1ZhbHVlczxudW1iZXI+IHtcbiAgICBjb25zdCBlbCAgICAgICAgICAgICAgPSBldi50YXJnZXQgfHwgZXYuc3JjRWxlbWVudDtcbiAgICBjb25zdCBwYWdlQ29vcmRpbmF0ZXMgPSBnZXRFdmVudFBhZ2VDb29yZGluYXRlcyhldik7XG4gICAgY29uc3QgY3VyRG9jdW1lbnQgICAgID0gZG9tVXRpbHMuZmluZERvY3VtZW50KGVsKTtcbiAgICBsZXQgeE9mZnNldCAgICAgICAgID0gMDtcbiAgICBsZXQgeU9mZnNldCAgICAgICAgID0gMDtcblxuICAgIGlmIChkb21VdGlscy5pc0VsZW1lbnRJbklmcmFtZShjdXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRJZnJhbWUgPSBkb21VdGlscy5nZXRJZnJhbWVCeUVsZW1lbnQoY3VyRG9jdW1lbnQpO1xuXG4gICAgICAgIGlmIChjdXJyZW50SWZyYW1lKSB7XG4gICAgICAgICAgICBjb25zdCBpZnJhbWVPZmZzZXQgID0gZ2V0T2Zmc2V0UG9zaXRpb24oY3VycmVudElmcmFtZSk7XG4gICAgICAgICAgICBjb25zdCBpZnJhbWVCb3JkZXJzID0gc3R5bGVVdGlscy5nZXRCb3JkZXJzV2lkdGgoY3VycmVudElmcmFtZSk7XG5cbiAgICAgICAgICAgIHhPZmZzZXQgPSBpZnJhbWVPZmZzZXQubGVmdCArIGlmcmFtZUJvcmRlcnMubGVmdDtcbiAgICAgICAgICAgIHlPZmZzZXQgPSBpZnJhbWVPZmZzZXQudG9wICsgaWZyYW1lQm9yZGVycy50b3A7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEF4aXNWYWx1ZXMocGFnZUNvb3JkaW5hdGVzLnggKyB4T2Zmc2V0LCBwYWdlQ29vcmRpbmF0ZXMueSArIHlPZmZzZXQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RXZlbnRQYWdlQ29vcmRpbmF0ZXMgKGV2OiBNb3VzZUV2ZW50KTogQXhpc1ZhbHVlczxudW1iZXI+IHtcbiAgICBjb25zdCBjdXJDb29yZE9iamVjdCA9IC9edG91Y2gvLnRlc3QoZXYudHlwZSkgJiYgKGV2IGFzIHVua25vd24gYXMgVG91Y2hFdmVudCkudGFyZ2V0VG91Y2hlcyA/IChldiBhcyB1bmtub3duIGFzIFRvdWNoRXZlbnQpLnRhcmdldFRvdWNoZXNbMF0gfHwgKGV2IGFzIHVua25vd24gYXMgVG91Y2hFdmVudCkuY2hhbmdlZFRvdWNoZXNbMF0gOiBldjtcblxuICAgIGNvbnN0IGJvdGhQYWdlQ29vcmRpbmF0ZXNBcmVaZXJvICAgICAgPSBjdXJDb29yZE9iamVjdC5wYWdlWCA9PT0gMCAmJiBjdXJDb29yZE9iamVjdC5wYWdlWSA9PT0gMDtcbiAgICBjb25zdCBub3RCb3RoQ2xpZW50Q29vcmRpbmF0ZXNBcmVaZXJvID0gY3VyQ29vcmRPYmplY3QuY2xpZW50WCAhPT0gMCB8fCBjdXJDb29yZE9iamVjdC5jbGllbnRZICE9PSAwO1xuXG4gICAgaWYgKChjdXJDb29yZE9iamVjdC5wYWdlWCA9PT0gbnVsbCB8fCBib3RoUGFnZUNvb3JkaW5hdGVzQXJlWmVybyAmJiBub3RCb3RoQ2xpZW50Q29vcmRpbmF0ZXNBcmVaZXJvKSAmJlxuICAgICAgICBjdXJDb29yZE9iamVjdC5jbGllbnRYICE9PSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnREb2N1bWVudCA9IGRvbVV0aWxzLmZpbmREb2N1bWVudChldi50YXJnZXQgfHwgZXYuc3JjRWxlbWVudCk7XG4gICAgICAgIGNvbnN0IGh0bWwgICAgICAgICAgICA9IGN1cnJlbnREb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG4gICAgICAgIGNvbnN0IGJvZHkgICAgICAgICAgICA9IGN1cnJlbnREb2N1bWVudC5ib2R5O1xuXG4gICAgICAgIHJldHVybiBuZXcgQXhpc1ZhbHVlczxudW1iZXI+KFxuICAgICAgICAgICAgTWF0aC5yb3VuZChjdXJDb29yZE9iamVjdC5jbGllbnRYICsgKGh0bWwgJiYgaHRtbC5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDApIC1cbiAgICAgICAgICAgICAgICAoaHRtbC5jbGllbnRMZWZ0IHx8IDApKSxcbiAgICAgICAgICAgIE1hdGgucm91bmQoY3VyQ29vcmRPYmplY3QuY2xpZW50WSArIChodG1sICYmIGh0bWwuc2Nyb2xsVG9wIHx8IGJvZHkgJiYgYm9keS5zY3JvbGxUb3AgfHwgMCkgLVxuICAgICAgICAgICAgICAgIChodG1sLmNsaWVudFRvcCB8fCAwKSlcbiAgICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBBeGlzVmFsdWVzPG51bWJlcj4oXG4gICAgICAgIE1hdGgucm91bmQoY3VyQ29vcmRPYmplY3QucGFnZVgpLFxuICAgICAgICBNYXRoLnJvdW5kKGN1ckNvb3JkT2JqZWN0LnBhZ2VZKVxuICAgICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJZnJhbWVQb2ludFJlbGF0aXZlVG9QYXJlbnRGcmFtZSAocG9zOiBBeGlzVmFsdWVzPG51bWJlcj4sIGlmcmFtZVdpbjogV2luZG93KTogQXhpc1ZhbHVlczxudW1iZXI+IHtcbiAgICBjb25zdCBpZnJhbWUgICAgICAgID0gZG9tVXRpbHMuZmluZElmcmFtZUJ5V2luZG93KGlmcmFtZVdpbik7XG4gICAgY29uc3QgaWZyYW1lT2Zmc2V0ICA9IGdldE9mZnNldFBvc2l0aW9uKGlmcmFtZSk7XG4gICAgY29uc3QgaWZyYW1lQm9yZGVycyA9IHN0eWxlVXRpbHMuZ2V0Qm9yZGVyc1dpZHRoKGlmcmFtZSk7XG4gICAgY29uc3QgaWZyYW1lUGFkZGluZyA9IHN0eWxlVXRpbHMuZ2V0RWxlbWVudFBhZGRpbmcoaWZyYW1lKTtcblxuICAgIHJldHVybiBvZmZzZXRUb0NsaWVudENvb3Jkcyh7XG4gICAgICAgIHg6IHBvcy54ICsgaWZyYW1lT2Zmc2V0LmxlZnQgKyBpZnJhbWVCb3JkZXJzLmxlZnQgKyBpZnJhbWVQYWRkaW5nLmxlZnQsXG4gICAgICAgIHk6IHBvcy55ICsgaWZyYW1lT2Zmc2V0LnRvcCArIGlmcmFtZUJvcmRlcnMudG9wICsgaWZyYW1lUGFkZGluZy50b3AsXG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQ2VudGVyIChlbDogSFRNTEVsZW1lbnQpOiBBeGlzVmFsdWVzPG51bWJlcj4ge1xuICAgIGNvbnN0IHJlY3RhbmdsZSA9IGdldEVsZW1lbnRSZWN0YW5nbGUoZWwpO1xuXG4gICAgcmV0dXJuIG5ldyBBeGlzVmFsdWVzPG51bWJlcj4oXG4gICAgICAgIE1hdGgucm91bmQocmVjdGFuZ2xlLmxlZnQgKyByZWN0YW5nbGUud2lkdGggLyAyKSxcbiAgICAgICAgTWF0aC5yb3VuZChyZWN0YW5nbGUudG9wICsgcmVjdGFuZ2xlLmhlaWdodCAvIDIpLFxuICAgICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDbGllbnRQb3NpdGlvbiAoZWw6IEhUTUxFbGVtZW50KTogYW55IHtcbiAgICBjb25zdCB7IGxlZnQsIHRvcCB9ID0gZ2V0T2Zmc2V0UG9zaXRpb24oZWwpO1xuXG4gICAgY29uc3QgY2xpZW50Q29vcmRzID0gb2Zmc2V0VG9DbGllbnRDb29yZHMoeyB4OiBsZWZ0LCB5OiB0b3AgfSk7XG5cbiAgICBjbGllbnRDb29yZHMueCA9IE1hdGgucm91bmQoY2xpZW50Q29vcmRzLngpO1xuICAgIGNsaWVudENvb3Jkcy55ID0gTWF0aC5yb3VuZChjbGllbnRDb29yZHMueSk7XG5cbiAgICByZXR1cm4gY2xpZW50Q29vcmRzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNJblJlY3RhbmdsZSAoeyB4LCB5IH06IEF4aXNWYWx1ZXM8bnVtYmVyPiwgcmVjdGFuZ2xlOiBCb3VuZGFyeVZhbHVlcyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB4ID49IHJlY3RhbmdsZS5sZWZ0ICYmIHggPD0gcmVjdGFuZ2xlLnJpZ2h0ICYmIHkgPj0gcmVjdGFuZ2xlLnRvcCAmJiB5IDw9IHJlY3RhbmdsZS5ib3R0b207XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRXaW5kb3dQb3NpdGlvbiAoKTogQXhpc1ZhbHVlczxudW1iZXI+IHtcbiAgICBjb25zdCB4ID0gd2luZG93LnNjcmVlbkxlZnQgfHwgd2luZG93LnNjcmVlblg7XG4gICAgY29uc3QgeSA9IHdpbmRvdy5zY3JlZW5Ub3AgfHwgd2luZG93LnNjcmVlblk7XG5cbiAgICByZXR1cm4gbmV3IEF4aXNWYWx1ZXMoeCwgeSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0lmcmFtZVZpc2libGUgKGVsOiBOb2RlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICFoaWRkZW5Vc2luZ1N0eWxlcyhlbCBhcyBIVE1MRWxlbWVudCk7XG59XG5cbmZ1bmN0aW9uIGhpZGRlblVzaW5nU3R5bGVzIChlbDogSFRNTEVsZW1lbnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3R5bGVVdGlscy5nZXQoZWwsICd2aXNpYmlsaXR5JykgPT09ICdoaWRkZW4nIHx8XG4gICAgICAgIHN0eWxlVXRpbHMuZ2V0KGVsLCAnZGlzcGxheScpID09PSAnbm9uZSc7XG59XG5cbmZ1bmN0aW9uIGhpZGRlbkJ5UmVjdGFuZ2xlIChlbDogSFRNTEVsZW1lbnQpOiBib29sZWFuIHtcbiAgICBjb25zdCBlbGVtZW50UmVjdGFuZ2xlID0gZ2V0RWxlbWVudFJlY3RhbmdsZShlbCk7XG5cbiAgICByZXR1cm4gZWxlbWVudFJlY3RhbmdsZS53aWR0aCA9PT0gMCB8fFxuICAgICAgICBlbGVtZW50UmVjdGFuZ2xlLmhlaWdodCA9PT0gMDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRWxlbWVudFZpc2libGUgKGVsOiBOb2RlKTogYm9vbGVhbiB7XG4gICAgaWYgKGRvbVV0aWxzLmlzVGV4dE5vZGUoZWwpKVxuICAgICAgICByZXR1cm4gIXN0eWxlVXRpbHMuaXNOb3RWaXNpYmxlTm9kZShlbCk7XG5cbiAgICBpZiAoIWRvbVV0aWxzLmlzQ29udGVudEVkaXRhYmxlRWxlbWVudChlbCkgJiZcbiAgICAgICAgIWRvbVV0aWxzLmlzU1ZHRWxlbWVudChlbCkgJiZcbiAgICAgICAgaGlkZGVuQnlSZWN0YW5nbGUoZWwgYXMgSFRNTEVsZW1lbnQpKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICBpZiAoZG9tVXRpbHMuaXNNYXBFbGVtZW50KGVsKSkge1xuICAgICAgICBjb25zdCBtYXBDb250YWluZXIgPSBkb21VdGlscy5nZXRNYXBDb250YWluZXIoZG9tVXRpbHMuY2xvc2VzdChlbCwgJ21hcCcpKTtcblxuICAgICAgICByZXR1cm4gbWFwQ29udGFpbmVyID8gaXNFbGVtZW50VmlzaWJsZShtYXBDb250YWluZXIpIDogZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHN0eWxlVXRpbHMuaXNTZWxlY3RWaXNpYmxlQ2hpbGQoZWwpKSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdCAgICAgICAgICAgICAgPSBkb21VdGlscy5nZXRTZWxlY3RQYXJlbnQoZWwpIGFzIEhUTUxTZWxlY3RFbGVtZW50O1xuICAgICAgICBjb25zdCBjaGlsZFJlYWxJbmRleCAgICAgID0gZG9tVXRpbHMuZ2V0Q2hpbGRWaXNpYmxlSW5kZXgoc2VsZWN0LCBlbCk7XG4gICAgICAgIGNvbnN0IHJlYWxTZWxlY3RTaXplVmFsdWUgPSBzdHlsZVV0aWxzLmdldFNlbGVjdEVsZW1lbnRTaXplKHNlbGVjdCk7XG4gICAgICAgIGNvbnN0IHRvcFZpc2libGVJbmRleCAgICAgPSBNYXRoLm1heChzdHlsZVV0aWxzLmdldFNjcm9sbFRvcChzZWxlY3QpIC8gc3R5bGVVdGlscy5nZXRPcHRpb25IZWlnaHQoc2VsZWN0KSwgMCk7XG4gICAgICAgIGNvbnN0IGJvdHRvbVZpc2libGVJbmRleCAgPSB0b3BWaXNpYmxlSW5kZXggKyByZWFsU2VsZWN0U2l6ZVZhbHVlIC0gMTtcbiAgICAgICAgY29uc3Qgb3B0aW9uVmlzaWJsZUluZGV4ICA9IE1hdGgubWF4KGNoaWxkUmVhbEluZGV4IC0gdG9wVmlzaWJsZUluZGV4LCAwKTtcblxuICAgICAgICByZXR1cm4gb3B0aW9uVmlzaWJsZUluZGV4ID49IHRvcFZpc2libGVJbmRleCAmJiBvcHRpb25WaXNpYmxlSW5kZXggPD0gYm90dG9tVmlzaWJsZUluZGV4O1xuICAgIH1cblxuICAgIGlmIChkb21VdGlscy5pc1NWR0VsZW1lbnQoZWwpKSB7XG4gICAgICAgIGNvbnN0IGhpZGRlblBhcmVudCA9IGRvbVV0aWxzLmZpbmRQYXJlbnQoZWwsIHRydWUsIChwYXJlbnQ6IE5vZGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBoaWRkZW5Vc2luZ1N0eWxlcyhwYXJlbnQgYXMgdW5rbm93biBhcyBIVE1MRWxlbWVudCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghaGlkZGVuUGFyZW50KVxuICAgICAgICAgICAgcmV0dXJuICFoaWRkZW5CeVJlY3RhbmdsZShlbCBhcyB1bmtub3duIGFzIEhUTUxFbGVtZW50KTtcblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0eWxlVXRpbHMuaGFzRGltZW5zaW9ucyhlbCBhcyBIVE1MRWxlbWVudCkgJiYgIWhpZGRlblVzaW5nU3R5bGVzKGVsIGFzIHVua25vd24gYXMgSFRNTEVsZW1lbnQpO1xufVxuXG4iXX0=