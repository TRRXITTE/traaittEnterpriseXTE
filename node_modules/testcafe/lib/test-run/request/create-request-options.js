"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createRequestOptions = void 0;
const lodash_1 = require("lodash");
const is_stream_1 = __importDefault(require("is-stream"));
const interfaces_1 = require("./interfaces");
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const content_types_1 = __importDefault(require("../../assets/content-types"));
const http_headers_1 = __importDefault(require("../../utils/http-headers"));
const types_1 = require("../../errors/types");
const runtime_1 = require("../../errors/runtime");
const actions_1 = require("../commands/actions");
const DEFAULT_ACCEPT = { [http_headers_1.default.accept]: `${content_types_1.default.json}, ${content_types_1.default.textPlain}, ${content_types_1.default.all}` };
const METHODS_WITH_CONTENT_TYPE = ['post', 'put', 'patch'];
const DEFAULT_REQUEST_METHOD = 'GET';
const DEFAULT_PROTOCOL = 'http:';
function setContentTypeIfNotExists(headers, value) {
    if (!lodash_1.isUndefined(headers) && lodash_1.isUndefined(headers[http_headers_1.default.contentType]))
        headers[http_headers_1.default.contentType] = value;
}
function typeOf(value) {
    if (value === null)
        return 'null';
    if (value && typeof value === 'object')
        return value.constructor.name.toLowerCase();
    return typeof value;
}
function transformBody(headers, body) {
    if (!body)
        return Buffer.from('');
    if (typeOf(body) === 'formdata' ||
        typeOf(body) === 'file' ||
        typeOf(body) === 'blob' ||
        lodash_1.isArrayBuffer(body) ||
        lodash_1.isBuffer(body) ||
        is_stream_1.default(body))
        return Buffer.from(body);
    else if (ArrayBuffer.isView(body))
        return Buffer.from(body.buffer);
    else if (body instanceof URLSearchParams) {
        setContentTypeIfNotExists(headers, `${content_types_1.default.urlencoded};charset=utf-8`);
        return Buffer.from(body.toString());
    }
    else if (lodash_1.isObject(body) || headers && headers[http_headers_1.default.contentType] === content_types_1.default.json) {
        setContentTypeIfNotExists(headers, content_types_1.default.json);
        return Buffer.from(JSON.stringify(body));
    }
    else if (typeof body === 'string')
        setContentTypeIfNotExists(headers, content_types_1.default.textPlain);
    return body;
}
function getAuthString(auth) {
    return 'Basic ' + Buffer.from(auth.username + ':' + auth.password, 'utf8').toString('base64');
}
function changeHeaderNamesToLowercase(headers) {
    const lowerCaseHeaders = {};
    Object.keys(headers).forEach(headerName => {
        lowerCaseHeaders[headerName.toLowerCase()] = headers[headerName];
    });
    return lowerCaseHeaders;
}
async function prepareHeaders(headers, currentPageUrl, url, body, testRun, withCredentials, options) {
    var _a;
    const { host, origin } = url;
    const preparedHeaders = Object.assign({}, DEFAULT_ACCEPT, changeHeaderNamesToLowercase(headers));
    preparedHeaders[http_headers_1.default.host] = host;
    preparedHeaders[http_headers_1.default.origin] = origin;
    preparedHeaders[http_headers_1.default.contentLength] = body.length;
    if (headers.method && METHODS_WITH_CONTENT_TYPE.includes(String(headers.method)))
        preparedHeaders[http_headers_1.default.contentType] = content_types_1.default.urlencoded;
    if (options.auth && withCredentials)
        preparedHeaders[http_headers_1.default.authorization] = getAuthString(options.auth);
    if ((_a = options.proxy) === null || _a === void 0 ? void 0 : _a.auth)
        preparedHeaders[http_headers_1.default.proxyAuthorization] = getAuthString(options.proxy.auth);
    if (withCredentials) {
        const currentPageCookies = testRun.session.cookies.getHeader({
            url: currentPageUrl.href,
            hostname: currentPageUrl.hostname,
        });
        if (currentPageCookies)
            preparedHeaders[http_headers_1.default.cookie] = currentPageCookies;
    }
    //NOTE: Additional header to recognize API requests in the hammerhead
    preparedHeaders[http_headers_1.default.isApiRequest] = 'true';
    return preparedHeaders;
}
async function prepareUrl(testRun, currentPageUrl, url, callsite) {
    let preparedUrl;
    try {
        preparedUrl = url instanceof URL
            ? url
            : new URL(url, currentPageUrl.hostname ? currentPageUrl.origin : void 0);
    }
    catch (e) {
        throw new runtime_1.APIError(callsite, types_1.RUNTIME_ERRORS.requestUrlInvalidValueError, url);
    }
    return preparedUrl;
}
function prepareSearchParams(url, params) {
    if (!params)
        return url;
    let searchParams;
    if (params instanceof URLSearchParams)
        searchParams = params;
    else {
        searchParams = new URLSearchParams();
        for (const key in params) {
            if (!params[key])
                continue;
            lodash_1.castArray(params[key]).forEach(v => {
                searchParams.append(key, typeof v === 'object' ? JSON.stringify(v) : String(v));
            });
        }
    }
    return `${url}${url.includes('?') ? '&' : '?'}${searchParams.toString()}`;
}
function getProxyUrl(testRun, url, withCredentials) {
    return testRun.executeCommand(new actions_1.GetProxyUrlCommand({
        url: url,
        options: { credentials: withCredentials ? interfaces_1.Credentials.include : interfaces_1.Credentials.omit },
    }, testRun, true));
}
async function createRequestOptions(currentPageUrl, testRun, options, callsite) {
    options.headers = options.headers || {};
    const url = await prepareUrl(testRun, currentPageUrl, options.url, callsite);
    const withCredentials = !currentPageUrl.host || testcafe_hammerhead_1.sameOriginCheck(currentPageUrl.href, url.href) || options.withCredentials || false;
    const body = transformBody(options.headers, options.body);
    const headers = await prepareHeaders(options.headers, currentPageUrl, url, body, testRun, withCredentials, options);
    const proxyUrl = await getProxyUrl(testRun, url.href, withCredentials);
    const proxyUrlObj = testcafe_hammerhead_1.parseProxyUrl(proxyUrl);
    let auth = options.auth;
    if (!auth && url.username && url.password) {
        auth = {
            username: url.username,
            password: url.password,
        };
    }
    const requestParams = {
        method: options.method || DEFAULT_REQUEST_METHOD,
        url: proxyUrl,
        protocol: DEFAULT_PROTOCOL,
        hostname: proxyUrlObj.proxy.hostname,
        host: proxyUrlObj.proxy.hostname,
        port: proxyUrlObj.proxy.port,
        path: prepareSearchParams(proxyUrlObj.partAfterHost, options.params),
        auth: auth && withCredentials ? `${auth.username}:${auth.password}` : void 0,
        headers: headers,
        credentials: withCredentials ? testRun.session.getAuthCredentials() : void 0,
        body: body,
        disableHttp2: testRun.session.isHttp2Disabled(),
        requestTimeout: {
            ajax: options.timeout,
            page: options.timeout,
        },
    };
    if (options.proxy) {
        requestParams.externalProxySettings = {
            host: options.proxy.host,
            hostname: options.proxy.host,
            port: options.proxy.port.toString(),
            proxyAuth: options.proxy.auth ? `${options.proxy.auth.username}:${options.proxy.auth.password}` : void 0,
        };
        requestParams.protocol = url.protocol;
        requestParams.host = url.host;
        requestParams.hostname = url.hostname;
        requestParams.port = url.port;
        requestParams.path = prepareSearchParams(url.pathname + url.search, options.params);
    }
    return new testcafe_hammerhead_1.RequestOptions(requestParams);
}
exports.createRequestOptions = createRequestOptions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXJlcXVlc3Qtb3B0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0LXJ1bi9yZXF1ZXN0L2NyZWF0ZS1yZXF1ZXN0LW9wdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsbUNBTWdCO0FBQ2hCLDBEQUFpQztBQUNqQyw2Q0FLc0I7QUFDdEIsNkRBSzZCO0FBRTdCLCtFQUF1RDtBQUN2RCw0RUFBb0Q7QUFDcEQsOENBQW9EO0FBQ3BELGtEQUFnRDtBQUNoRCxpREFBeUQ7QUFHekQsTUFBTSxjQUFjLEdBQWMsRUFBRSxDQUFDLHNCQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyx1QkFBYSxDQUFDLElBQUksS0FBSyx1QkFBYSxDQUFDLFNBQVMsS0FBSyx1QkFBYSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDdkksTUFBTSx5QkFBeUIsR0FBRyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0QsTUFBTSxzQkFBc0IsR0FBTSxLQUFLLENBQUM7QUFDeEMsTUFBTSxnQkFBZ0IsR0FBWSxPQUFPLENBQUM7QUFFMUMsU0FBUyx5QkFBeUIsQ0FBRSxPQUE0QixFQUFFLEtBQWE7SUFDM0UsSUFBSSxDQUFDLG9CQUFXLENBQUMsT0FBTyxDQUFDLElBQUksb0JBQVcsQ0FBQyxPQUFPLENBQUMsc0JBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN2RSxPQUFPLENBQUMsc0JBQVksQ0FBQyxXQUFXLENBQUMsR0FBRyxLQUFLLENBQUM7QUFDbEQsQ0FBQztBQUVELFNBQVMsTUFBTSxDQUFFLEtBQWM7SUFDM0IsSUFBSSxLQUFLLEtBQUssSUFBSTtRQUNkLE9BQU8sTUFBTSxDQUFDO0lBRWxCLElBQUksS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVE7UUFDbEMsT0FBTyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUVoRCxPQUFPLE9BQU8sS0FBSyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBRSxPQUE0QixFQUFFLElBQVU7SUFDNUQsSUFBSSxDQUFDLElBQUk7UUFDTCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFM0IsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssVUFBVTtRQUMzQixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssTUFBTTtRQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssTUFBTTtRQUN2QixzQkFBYSxDQUFDLElBQUksQ0FBQztRQUNuQixpQkFBUSxDQUFDLElBQUksQ0FBQztRQUNkLG1CQUFRLENBQUMsSUFBSSxDQUFDO1FBRWQsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hCLElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDN0IsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUUvQixJQUFJLElBQUksWUFBWSxlQUFlLEVBQUU7UUFDdEMseUJBQXlCLENBQUMsT0FBTyxFQUFFLEdBQUcsdUJBQWEsQ0FBQyxVQUFVLGdCQUFnQixDQUFDLENBQUM7UUFFaEYsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0tBQ3ZDO1NBQ0ksSUFBSSxpQkFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsc0JBQVksQ0FBQyxXQUFXLENBQUMsS0FBSyx1QkFBYSxDQUFDLElBQUksRUFBRTtRQUM1Rix5QkFBeUIsQ0FBQyxPQUFPLEVBQUUsdUJBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2RCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0tBQzVDO1NBQ0ksSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRO1FBQzdCLHlCQUF5QixDQUFDLE9BQU8sRUFBRSx1QkFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRWhFLE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBRSxJQUFpQjtJQUNyQyxPQUFPLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2xHLENBQUM7QUFFRCxTQUFTLDRCQUE0QixDQUFFLE9BQTRCO0lBQy9ELE1BQU0sZ0JBQWdCLEdBQXdCLEVBQUUsQ0FBQztJQUVqRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUN0QyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckUsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLGdCQUFnQixDQUFDO0FBQzVCLENBQUM7QUFFRCxLQUFLLFVBQVUsY0FBYyxDQUFFLE9BQTRCLEVBQUUsY0FBbUIsRUFBRSxHQUFRLEVBQUUsSUFBWSxFQUFFLE9BQWdCLEVBQUUsZUFBd0IsRUFBRSxPQUErQjs7SUFDakwsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUM7SUFFN0IsTUFBTSxlQUFlLEdBQXdCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGNBQWMsRUFBRSw0QkFBNEIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBR3RILGVBQWUsQ0FBQyxzQkFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztJQUMxQyxlQUFlLENBQUMsc0JBQVksQ0FBQyxNQUFNLENBQUMsR0FBRyxNQUFNLENBQUM7SUFDOUMsZUFBZSxDQUFDLHNCQUFZLENBQUMsYUFBYSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUUxRCxJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUkseUJBQXlCLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDNUUsZUFBZSxDQUFDLHNCQUFZLENBQUMsV0FBVyxDQUFDLEdBQUcsdUJBQWEsQ0FBQyxVQUFVLENBQUM7SUFFekUsSUFBSSxPQUFPLENBQUMsSUFBSSxJQUFJLGVBQWU7UUFDL0IsZUFBZSxDQUFDLHNCQUFZLENBQUMsYUFBYSxDQUFDLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUU5RSxVQUFJLE9BQU8sQ0FBQyxLQUFLLDBDQUFFLElBQUk7UUFDbkIsZUFBZSxDQUFDLHNCQUFZLENBQUMsa0JBQWtCLENBQUMsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV6RixJQUFJLGVBQWUsRUFBRTtRQUNqQixNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUN6RCxHQUFHLEVBQU8sY0FBYyxDQUFDLElBQUk7WUFDN0IsUUFBUSxFQUFFLGNBQWMsQ0FBQyxRQUFRO1NBQ3BDLENBQUMsQ0FBQztRQUVILElBQUksa0JBQWtCO1lBQ2xCLGVBQWUsQ0FBQyxzQkFBWSxDQUFDLE1BQU0sQ0FBQyxHQUFHLGtCQUFrQixDQUFDO0tBQ2pFO0lBRUQscUVBQXFFO0lBQ3JFLGVBQWUsQ0FBQyxzQkFBWSxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sQ0FBQztJQUVwRCxPQUFPLGVBQWUsQ0FBQztBQUMzQixDQUFDO0FBRUQsS0FBSyxVQUFVLFVBQVUsQ0FBRSxPQUFnQixFQUFFLGNBQW1CLEVBQUUsR0FBaUIsRUFBRSxRQUErQjtJQUNoSCxJQUFJLFdBQWdCLENBQUM7SUFFckIsSUFBSTtRQUNBLFdBQVcsR0FBRyxHQUFHLFlBQVksR0FBRztZQUM1QixDQUFDLENBQUMsR0FBRztZQUNMLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztLQUNoRjtJQUNELE9BQU8sQ0FBQyxFQUFFO1FBQ04sTUFBTSxJQUFJLGtCQUFRLENBQUMsUUFBUSxFQUFFLHNCQUFjLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxDQUFDLENBQUM7S0FDakY7SUFFRCxPQUFPLFdBQVcsQ0FBQztBQUN2QixDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBRSxHQUFXLEVBQUUsTUFBZTtJQUN0RCxJQUFJLENBQUMsTUFBTTtRQUNQLE9BQU8sR0FBRyxDQUFDO0lBRWYsSUFBSSxZQUE2QixDQUFDO0lBRWxDLElBQUksTUFBTSxZQUFZLGVBQWU7UUFDakMsWUFBWSxHQUFHLE1BQU0sQ0FBQztTQUNyQjtRQUNELFlBQVksR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBRXJDLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUNaLFNBQVM7WUFFYixrQkFBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDL0IsWUFBWSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRixDQUFDLENBQUMsQ0FBQztTQUNOO0tBQ0o7SUFFRCxPQUFPLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLFlBQVksQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDO0FBQzlFLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBRSxPQUFnQixFQUFFLEdBQVcsRUFBRSxlQUF5QjtJQUMxRSxPQUFPLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSw0QkFBa0IsQ0FBQztRQUNqRCxHQUFHLEVBQU0sR0FBRztRQUNaLE9BQU8sRUFBRSxFQUFFLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLHdCQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyx3QkFBVyxDQUFDLElBQUksRUFBRTtLQUNyRixFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBb0IsQ0FBQztBQUMxQyxDQUFDO0FBRU0sS0FBSyxVQUFVLG9CQUFvQixDQUFFLGNBQW1CLEVBQUUsT0FBZ0IsRUFBRSxPQUErQixFQUFFLFFBQStCO0lBQy9JLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFFeEMsTUFBTSxHQUFHLEdBQWUsTUFBTSxVQUFVLENBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3pGLE1BQU0sZUFBZSxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxxQ0FBZSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxlQUFlLElBQUksS0FBSyxDQUFDO0lBQ25JLE1BQU0sSUFBSSxHQUFjLGFBQWEsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyRSxNQUFNLE9BQU8sR0FBVyxNQUFNLGNBQWMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDNUgsTUFBTSxRQUFRLEdBQVUsTUFBTSxXQUFXLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDOUUsTUFBTSxXQUFXLEdBQU8sbUNBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNoRCxJQUFJLElBQUksR0FBZ0IsT0FBTyxDQUFDLElBQUksQ0FBQztJQUVyQyxJQUFJLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRTtRQUN2QyxJQUFJLEdBQUc7WUFDSCxRQUFRLEVBQUUsR0FBRyxDQUFDLFFBQVE7WUFDdEIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1NBQ3pCLENBQUM7S0FDTDtJQUVELE1BQU0sYUFBYSxHQUF5QjtRQUN4QyxNQUFNLEVBQVUsT0FBTyxDQUFDLE1BQU0sSUFBSSxzQkFBc0I7UUFDeEQsR0FBRyxFQUFhLFFBQVE7UUFDeEIsUUFBUSxFQUFRLGdCQUFnQjtRQUNoQyxRQUFRLEVBQVEsV0FBVyxDQUFDLEtBQUssQ0FBQyxRQUFRO1FBQzFDLElBQUksRUFBWSxXQUFXLENBQUMsS0FBSyxDQUFDLFFBQVE7UUFDMUMsSUFBSSxFQUFZLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSTtRQUN0QyxJQUFJLEVBQVksbUJBQW1CLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQzlFLElBQUksRUFBWSxJQUFJLElBQUksZUFBZSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDdEYsT0FBTyxFQUFTLE9BQU87UUFDdkIsV0FBVyxFQUFLLGVBQWUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDL0UsSUFBSSxFQUFZLElBQUk7UUFDcEIsWUFBWSxFQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFO1FBQ2pELGNBQWMsRUFBRTtZQUNaLElBQUksRUFBRSxPQUFPLENBQUMsT0FBTztZQUNyQixJQUFJLEVBQUUsT0FBTyxDQUFDLE9BQU87U0FDeEI7S0FDSixDQUFDO0lBRUYsSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFO1FBQ2YsYUFBYSxDQUFDLHFCQUFxQixHQUFHO1lBQ2xDLElBQUksRUFBTyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUk7WUFDN0IsUUFBUSxFQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUM3QixJQUFJLEVBQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ3hDLFNBQVMsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztTQUMzRyxDQUFDO1FBRUYsYUFBYSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3RDLGFBQWEsQ0FBQyxJQUFJLEdBQU8sR0FBRyxDQUFDLElBQUksQ0FBQztRQUNsQyxhQUFhLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7UUFDdEMsYUFBYSxDQUFDLElBQUksR0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ2xDLGFBQWEsQ0FBQyxJQUFJLEdBQU8sbUJBQW1CLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUMzRjtJQUVELE9BQU8sSUFBSSxvQ0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFyREQsb0RBcURDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3V0Z29pbmdIdHRwSGVhZGVycyB9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IHtcbiAgICBjYXN0QXJyYXksXG4gICAgaXNBcnJheUJ1ZmZlcixcbiAgICBpc0J1ZmZlcixcbiAgICBpc09iamVjdCxcbiAgICBpc1VuZGVmaW5lZCxcbn0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBpc1N0cmVhbSBmcm9tICdpcy1zdHJlYW0nO1xuaW1wb3J0IHtcbiAgICBBdXRoT3B0aW9ucyxcbiAgICBDcmVkZW50aWFscyxcbiAgICBFeHRlcm5hbFJlcXVlc3RPcHRpb25zLFxuICAgIFBhcmFtcyxcbn0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7XG4gICAgUmVxdWVzdE9wdGlvbnMsXG4gICAgcGFyc2VQcm94eVVybCxcbiAgICBSZXF1ZXN0T3B0aW9uc1BhcmFtcyxcbiAgICBzYW1lT3JpZ2luQ2hlY2ssXG59IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IFRlc3RSdW4gZnJvbSAnLi4vaW5kZXgnO1xuaW1wb3J0IENPTlRFTlRfVFlQRVMgZnJvbSAnLi4vLi4vYXNzZXRzL2NvbnRlbnQtdHlwZXMnO1xuaW1wb3J0IEhUVFBfSEVBREVSUyBmcm9tICcuLi8uLi91dGlscy9odHRwLWhlYWRlcnMnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IHsgQVBJRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBHZXRQcm94eVVybENvbW1hbmQgfSBmcm9tICcuLi9jb21tYW5kcy9hY3Rpb25zJztcbmltcG9ydCB7IENhbGxzaXRlUmVjb3JkIH0gZnJvbSAnY2FsbHNpdGUtcmVjb3JkJztcblxuY29uc3QgREVGQVVMVF9BQ0NFUFQgICAgICAgICAgICA9IHsgW0hUVFBfSEVBREVSUy5hY2NlcHRdOiBgJHtDT05URU5UX1RZUEVTLmpzb259LCAke0NPTlRFTlRfVFlQRVMudGV4dFBsYWlufSwgJHtDT05URU5UX1RZUEVTLmFsbH1gIH07XG5jb25zdCBNRVRIT0RTX1dJVEhfQ09OVEVOVF9UWVBFID0gWydwb3N0JywgJ3B1dCcsICdwYXRjaCddO1xuY29uc3QgREVGQVVMVF9SRVFVRVNUX01FVEhPRCAgICA9ICdHRVQnO1xuY29uc3QgREVGQVVMVF9QUk9UT0NPTCAgICAgICAgICA9ICdodHRwOic7XG5cbmZ1bmN0aW9uIHNldENvbnRlbnRUeXBlSWZOb3RFeGlzdHMgKGhlYWRlcnM6IE91dGdvaW5nSHR0cEhlYWRlcnMsIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIWlzVW5kZWZpbmVkKGhlYWRlcnMpICYmIGlzVW5kZWZpbmVkKGhlYWRlcnNbSFRUUF9IRUFERVJTLmNvbnRlbnRUeXBlXSkpXG4gICAgICAgIGhlYWRlcnNbSFRUUF9IRUFERVJTLmNvbnRlbnRUeXBlXSA9IHZhbHVlO1xufVxuXG5mdW5jdGlvbiB0eXBlT2YgKHZhbHVlOiB1bmtub3duKTogc3RyaW5nIHtcbiAgICBpZiAodmFsdWUgPT09IG51bGwpXG4gICAgICAgIHJldHVybiAnbnVsbCc7XG5cbiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JylcbiAgICAgICAgcmV0dXJuIHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUudG9Mb3dlckNhc2UoKTtcblxuICAgIHJldHVybiB0eXBlb2YgdmFsdWU7XG59XG5cbmZ1bmN0aW9uIHRyYW5zZm9ybUJvZHkgKGhlYWRlcnM6IE91dGdvaW5nSHR0cEhlYWRlcnMsIGJvZHk/OiBhbnkpOiBCdWZmZXIge1xuICAgIGlmICghYm9keSlcbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKCcnKTtcblxuICAgIGlmICh0eXBlT2YoYm9keSkgPT09ICdmb3JtZGF0YScgfHxcbiAgICAgICAgdHlwZU9mKGJvZHkpID09PSAnZmlsZScgfHxcbiAgICAgICAgdHlwZU9mKGJvZHkpID09PSAnYmxvYicgfHxcbiAgICAgICAgaXNBcnJheUJ1ZmZlcihib2R5KSB8fFxuICAgICAgICBpc0J1ZmZlcihib2R5KSB8fFxuICAgICAgICBpc1N0cmVhbShib2R5KVxuICAgIClcbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJvZHkpO1xuICAgIGVsc2UgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhib2R5KSlcbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJvZHkuYnVmZmVyKTtcblxuICAgIGVsc2UgaWYgKGJvZHkgaW5zdGFuY2VvZiBVUkxTZWFyY2hQYXJhbXMpIHtcbiAgICAgICAgc2V0Q29udGVudFR5cGVJZk5vdEV4aXN0cyhoZWFkZXJzLCBgJHtDT05URU5UX1RZUEVTLnVybGVuY29kZWR9O2NoYXJzZXQ9dXRmLThgKTtcblxuICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oYm9keS50b1N0cmluZygpKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoaXNPYmplY3QoYm9keSkgfHwgaGVhZGVycyAmJiBoZWFkZXJzW0hUVFBfSEVBREVSUy5jb250ZW50VHlwZV0gPT09IENPTlRFTlRfVFlQRVMuanNvbikge1xuICAgICAgICBzZXRDb250ZW50VHlwZUlmTm90RXhpc3RzKGhlYWRlcnMsIENPTlRFTlRfVFlQRVMuanNvbik7XG5cbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGJvZHkpKTtcbiAgICB9XG4gICAgZWxzZSBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKVxuICAgICAgICBzZXRDb250ZW50VHlwZUlmTm90RXhpc3RzKGhlYWRlcnMsIENPTlRFTlRfVFlQRVMudGV4dFBsYWluKTtcblxuICAgIHJldHVybiBib2R5O1xufVxuXG5mdW5jdGlvbiBnZXRBdXRoU3RyaW5nIChhdXRoOiBBdXRoT3B0aW9ucyk6IHN0cmluZyB7XG4gICAgcmV0dXJuICdCYXNpYyAnICsgQnVmZmVyLmZyb20oYXV0aC51c2VybmFtZSArICc6JyArIGF1dGgucGFzc3dvcmQsICd1dGY4JykudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufVxuXG5mdW5jdGlvbiBjaGFuZ2VIZWFkZXJOYW1lc1RvTG93ZXJjYXNlIChoZWFkZXJzOiBPdXRnb2luZ0h0dHBIZWFkZXJzKTogT3V0Z29pbmdIdHRwSGVhZGVycyB7XG4gICAgY29uc3QgbG93ZXJDYXNlSGVhZGVyczogT3V0Z29pbmdIdHRwSGVhZGVycyA9IHt9O1xuXG4gICAgT2JqZWN0LmtleXMoaGVhZGVycykuZm9yRWFjaChoZWFkZXJOYW1lID0+IHtcbiAgICAgICAgbG93ZXJDYXNlSGVhZGVyc1toZWFkZXJOYW1lLnRvTG93ZXJDYXNlKCldID0gaGVhZGVyc1toZWFkZXJOYW1lXTtcbiAgICB9KTtcblxuICAgIHJldHVybiBsb3dlckNhc2VIZWFkZXJzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlSGVhZGVycyAoaGVhZGVyczogT3V0Z29pbmdIdHRwSGVhZGVycywgY3VycmVudFBhZ2VVcmw6IFVSTCwgdXJsOiBVUkwsIGJvZHk6IEJ1ZmZlciwgdGVzdFJ1bjogVGVzdFJ1biwgd2l0aENyZWRlbnRpYWxzOiBib29sZWFuLCBvcHRpb25zOiBFeHRlcm5hbFJlcXVlc3RPcHRpb25zKTogUHJvbWlzZTxPdXRnb2luZ0h0dHBIZWFkZXJzPiB7XG4gICAgY29uc3QgeyBob3N0LCBvcmlnaW4gfSA9IHVybDtcblxuICAgIGNvbnN0IHByZXBhcmVkSGVhZGVyczogT3V0Z29pbmdIdHRwSGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfQUNDRVBULCBjaGFuZ2VIZWFkZXJOYW1lc1RvTG93ZXJjYXNlKGhlYWRlcnMpKTtcblxuXG4gICAgcHJlcGFyZWRIZWFkZXJzW0hUVFBfSEVBREVSUy5ob3N0XSA9IGhvc3Q7XG4gICAgcHJlcGFyZWRIZWFkZXJzW0hUVFBfSEVBREVSUy5vcmlnaW5dID0gb3JpZ2luO1xuICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuY29udGVudExlbmd0aF0gPSBib2R5Lmxlbmd0aDtcblxuICAgIGlmIChoZWFkZXJzLm1ldGhvZCAmJiBNRVRIT0RTX1dJVEhfQ09OVEVOVF9UWVBFLmluY2x1ZGVzKFN0cmluZyhoZWFkZXJzLm1ldGhvZCkpKVxuICAgICAgICBwcmVwYXJlZEhlYWRlcnNbSFRUUF9IRUFERVJTLmNvbnRlbnRUeXBlXSA9IENPTlRFTlRfVFlQRVMudXJsZW5jb2RlZDtcblxuICAgIGlmIChvcHRpb25zLmF1dGggJiYgd2l0aENyZWRlbnRpYWxzKVxuICAgICAgICBwcmVwYXJlZEhlYWRlcnNbSFRUUF9IRUFERVJTLmF1dGhvcml6YXRpb25dID0gZ2V0QXV0aFN0cmluZyhvcHRpb25zLmF1dGgpO1xuXG4gICAgaWYgKG9wdGlvbnMucHJveHk/LmF1dGgpXG4gICAgICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMucHJveHlBdXRob3JpemF0aW9uXSA9IGdldEF1dGhTdHJpbmcob3B0aW9ucy5wcm94eS5hdXRoKTtcblxuICAgIGlmICh3aXRoQ3JlZGVudGlhbHMpIHtcbiAgICAgICAgY29uc3QgY3VycmVudFBhZ2VDb29raWVzID0gdGVzdFJ1bi5zZXNzaW9uLmNvb2tpZXMuZ2V0SGVhZGVyKHtcbiAgICAgICAgICAgIHVybDogICAgICBjdXJyZW50UGFnZVVybC5ocmVmLFxuICAgICAgICAgICAgaG9zdG5hbWU6IGN1cnJlbnRQYWdlVXJsLmhvc3RuYW1lLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoY3VycmVudFBhZ2VDb29raWVzKVxuICAgICAgICAgICAgcHJlcGFyZWRIZWFkZXJzW0hUVFBfSEVBREVSUy5jb29raWVdID0gY3VycmVudFBhZ2VDb29raWVzO1xuICAgIH1cblxuICAgIC8vTk9URTogQWRkaXRpb25hbCBoZWFkZXIgdG8gcmVjb2duaXplIEFQSSByZXF1ZXN0cyBpbiB0aGUgaGFtbWVyaGVhZFxuICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuaXNBcGlSZXF1ZXN0XSA9ICd0cnVlJztcblxuICAgIHJldHVybiBwcmVwYXJlZEhlYWRlcnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByZXBhcmVVcmwgKHRlc3RSdW46IFRlc3RSdW4sIGN1cnJlbnRQYWdlVXJsOiBVUkwsIHVybDogc3RyaW5nIHwgVVJMLCBjYWxsc2l0ZTogQ2FsbHNpdGVSZWNvcmQgfCBudWxsKTogUHJvbWlzZTxVUkw+IHtcbiAgICBsZXQgcHJlcGFyZWRVcmw6IFVSTDtcblxuICAgIHRyeSB7XG4gICAgICAgIHByZXBhcmVkVXJsID0gdXJsIGluc3RhbmNlb2YgVVJMXG4gICAgICAgICAgICA/IHVybFxuICAgICAgICAgICAgOiBuZXcgVVJMKHVybCwgY3VycmVudFBhZ2VVcmwuaG9zdG5hbWUgPyBjdXJyZW50UGFnZVVybC5vcmlnaW4gOiB2b2lkIDApO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgQVBJRXJyb3IoY2FsbHNpdGUsIFJVTlRJTUVfRVJST1JTLnJlcXVlc3RVcmxJbnZhbGlkVmFsdWVFcnJvciwgdXJsKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJlcGFyZWRVcmw7XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVTZWFyY2hQYXJhbXMgKHVybDogc3RyaW5nLCBwYXJhbXM/OiBQYXJhbXMpOiBzdHJpbmcge1xuICAgIGlmICghcGFyYW1zKVxuICAgICAgICByZXR1cm4gdXJsO1xuXG4gICAgbGV0IHNlYXJjaFBhcmFtczogVVJMU2VhcmNoUGFyYW1zO1xuXG4gICAgaWYgKHBhcmFtcyBpbnN0YW5jZW9mIFVSTFNlYXJjaFBhcmFtcylcbiAgICAgICAgc2VhcmNoUGFyYW1zID0gcGFyYW1zO1xuICAgIGVsc2Uge1xuICAgICAgICBzZWFyY2hQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7XG5cbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcGFyYW1zKSB7XG4gICAgICAgICAgICBpZiAoIXBhcmFtc1trZXldKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICBjYXN0QXJyYXkocGFyYW1zW2tleV0pLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICAgICAgc2VhcmNoUGFyYW1zLmFwcGVuZChrZXksIHR5cGVvZiB2ID09PSAnb2JqZWN0JyA/IEpTT04uc3RyaW5naWZ5KHYpIDogU3RyaW5nKHYpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGAke3VybH0ke3VybC5pbmNsdWRlcygnPycpID8gJyYnIDogJz8nfSR7c2VhcmNoUGFyYW1zLnRvU3RyaW5nKCl9YDtcbn1cblxuZnVuY3Rpb24gZ2V0UHJveHlVcmwgKHRlc3RSdW46IFRlc3RSdW4sIHVybDogc3RyaW5nLCB3aXRoQ3JlZGVudGlhbHM/OiBib29sZWFuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGVzdFJ1bi5leGVjdXRlQ29tbWFuZChuZXcgR2V0UHJveHlVcmxDb21tYW5kKHtcbiAgICAgICAgdXJsOiAgICAgdXJsLFxuICAgICAgICBvcHRpb25zOiB7IGNyZWRlbnRpYWxzOiB3aXRoQ3JlZGVudGlhbHMgPyBDcmVkZW50aWFscy5pbmNsdWRlIDogQ3JlZGVudGlhbHMub21pdCB9LFxuICAgIH0sIHRlc3RSdW4sIHRydWUpKSBhcyBQcm9taXNlPHN0cmluZz47XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVSZXF1ZXN0T3B0aW9ucyAoY3VycmVudFBhZ2VVcmw6IFVSTCwgdGVzdFJ1bjogVGVzdFJ1biwgb3B0aW9uczogRXh0ZXJuYWxSZXF1ZXN0T3B0aW9ucywgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkIHwgbnVsbCk6IFByb21pc2U8UmVxdWVzdE9wdGlvbnM+IHtcbiAgICBvcHRpb25zLmhlYWRlcnMgPSBvcHRpb25zLmhlYWRlcnMgfHwge307XG5cbiAgICBjb25zdCB1cmwgICAgICAgICAgICAgPSBhd2FpdCBwcmVwYXJlVXJsKHRlc3RSdW4sIGN1cnJlbnRQYWdlVXJsLCBvcHRpb25zLnVybCwgY2FsbHNpdGUpO1xuICAgIGNvbnN0IHdpdGhDcmVkZW50aWFscyA9ICFjdXJyZW50UGFnZVVybC5ob3N0IHx8IHNhbWVPcmlnaW5DaGVjayhjdXJyZW50UGFnZVVybC5ocmVmLCB1cmwuaHJlZikgfHwgb3B0aW9ucy53aXRoQ3JlZGVudGlhbHMgfHwgZmFsc2U7XG4gICAgY29uc3QgYm9keSAgICAgICAgICAgID0gdHJhbnNmb3JtQm9keShvcHRpb25zLmhlYWRlcnMsIG9wdGlvbnMuYm9keSk7XG4gICAgY29uc3QgaGVhZGVycyAgICAgICAgID0gYXdhaXQgcHJlcGFyZUhlYWRlcnMob3B0aW9ucy5oZWFkZXJzLCBjdXJyZW50UGFnZVVybCwgdXJsLCBib2R5LCB0ZXN0UnVuLCB3aXRoQ3JlZGVudGlhbHMsIG9wdGlvbnMpO1xuICAgIGNvbnN0IHByb3h5VXJsICAgICAgICA9IGF3YWl0IGdldFByb3h5VXJsKHRlc3RSdW4sIHVybC5ocmVmLCB3aXRoQ3JlZGVudGlhbHMpO1xuICAgIGNvbnN0IHByb3h5VXJsT2JqICAgICA9IHBhcnNlUHJveHlVcmwocHJveHlVcmwpO1xuICAgIGxldCBhdXRoICAgICAgICAgICAgICA9IG9wdGlvbnMuYXV0aDtcblxuICAgIGlmICghYXV0aCAmJiB1cmwudXNlcm5hbWUgJiYgdXJsLnBhc3N3b3JkKSB7XG4gICAgICAgIGF1dGggPSB7XG4gICAgICAgICAgICB1c2VybmFtZTogdXJsLnVzZXJuYW1lLFxuICAgICAgICAgICAgcGFzc3dvcmQ6IHVybC5wYXNzd29yZCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0UGFyYW1zOiBSZXF1ZXN0T3B0aW9uc1BhcmFtcyA9IHtcbiAgICAgICAgbWV0aG9kOiAgICAgICAgIG9wdGlvbnMubWV0aG9kIHx8IERFRkFVTFRfUkVRVUVTVF9NRVRIT0QsXG4gICAgICAgIHVybDogICAgICAgICAgICBwcm94eVVybCxcbiAgICAgICAgcHJvdG9jb2w6ICAgICAgIERFRkFVTFRfUFJPVE9DT0wsXG4gICAgICAgIGhvc3RuYW1lOiAgICAgICBwcm94eVVybE9iai5wcm94eS5ob3N0bmFtZSxcbiAgICAgICAgaG9zdDogICAgICAgICAgIHByb3h5VXJsT2JqLnByb3h5Lmhvc3RuYW1lLFxuICAgICAgICBwb3J0OiAgICAgICAgICAgcHJveHlVcmxPYmoucHJveHkucG9ydCxcbiAgICAgICAgcGF0aDogICAgICAgICAgIHByZXBhcmVTZWFyY2hQYXJhbXMocHJveHlVcmxPYmoucGFydEFmdGVySG9zdCwgb3B0aW9ucy5wYXJhbXMpLFxuICAgICAgICBhdXRoOiAgICAgICAgICAgYXV0aCAmJiB3aXRoQ3JlZGVudGlhbHMgPyBgJHthdXRoLnVzZXJuYW1lfToke2F1dGgucGFzc3dvcmR9YCA6IHZvaWQgMCxcbiAgICAgICAgaGVhZGVyczogICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGNyZWRlbnRpYWxzOiAgICB3aXRoQ3JlZGVudGlhbHMgPyB0ZXN0UnVuLnNlc3Npb24uZ2V0QXV0aENyZWRlbnRpYWxzKCkgOiB2b2lkIDAsXG4gICAgICAgIGJvZHk6ICAgICAgICAgICBib2R5LFxuICAgICAgICBkaXNhYmxlSHR0cDI6ICAgdGVzdFJ1bi5zZXNzaW9uLmlzSHR0cDJEaXNhYmxlZCgpLFxuICAgICAgICByZXF1ZXN0VGltZW91dDoge1xuICAgICAgICAgICAgYWpheDogb3B0aW9ucy50aW1lb3V0LFxuICAgICAgICAgICAgcGFnZTogb3B0aW9ucy50aW1lb3V0LFxuICAgICAgICB9LFxuICAgIH07XG5cbiAgICBpZiAob3B0aW9ucy5wcm94eSkge1xuICAgICAgICByZXF1ZXN0UGFyYW1zLmV4dGVybmFsUHJveHlTZXR0aW5ncyA9IHtcbiAgICAgICAgICAgIGhvc3Q6ICAgICAgb3B0aW9ucy5wcm94eS5ob3N0LFxuICAgICAgICAgICAgaG9zdG5hbWU6ICBvcHRpb25zLnByb3h5Lmhvc3QsXG4gICAgICAgICAgICBwb3J0OiAgICAgIG9wdGlvbnMucHJveHkucG9ydC50b1N0cmluZygpLFxuICAgICAgICAgICAgcHJveHlBdXRoOiBvcHRpb25zLnByb3h5LmF1dGggPyBgJHtvcHRpb25zLnByb3h5LmF1dGgudXNlcm5hbWV9OiR7b3B0aW9ucy5wcm94eS5hdXRoLnBhc3N3b3JkfWAgOiB2b2lkIDAsXG4gICAgICAgIH07XG5cbiAgICAgICAgcmVxdWVzdFBhcmFtcy5wcm90b2NvbCA9IHVybC5wcm90b2NvbDtcbiAgICAgICAgcmVxdWVzdFBhcmFtcy5ob3N0ICAgICA9IHVybC5ob3N0O1xuICAgICAgICByZXF1ZXN0UGFyYW1zLmhvc3RuYW1lID0gdXJsLmhvc3RuYW1lO1xuICAgICAgICByZXF1ZXN0UGFyYW1zLnBvcnQgICAgID0gdXJsLnBvcnQ7XG4gICAgICAgIHJlcXVlc3RQYXJhbXMucGF0aCAgICAgPSBwcmVwYXJlU2VhcmNoUGFyYW1zKHVybC5wYXRobmFtZSArIHVybC5zZWFyY2gsIG9wdGlvbnMucGFyYW1zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFJlcXVlc3RPcHRpb25zKHJlcXVlc3RQYXJhbXMpO1xufVxuIl19