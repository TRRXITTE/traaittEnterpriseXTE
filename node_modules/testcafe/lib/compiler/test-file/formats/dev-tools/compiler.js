"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const raw_1 = __importDefault(require("../raw"));
const factory_1 = require("./commands/factory");
const switch_to_iframe_1 = require("./commands/switch-to-iframe");
const switch_to_main_window_1 = require("./commands/switch-to-main-window");
const TEST_BASE = JSON.stringify({
    fixtures: [
        {
            name: 'New Fixture',
            tests: [
                {
                    name: 'New Test',
                    commands: [],
                },
            ],
        },
    ],
});
class DevToolsTestFileCompiler extends raw_1.default {
    constructor() {
        super(...arguments);
        this.raw = { fixtures: [] };
    }
    _hasTests() {
        return true;
    }
    get _fixture() {
        return this.raw.fixtures[0];
    }
    get _test() {
        return this._fixture.tests[0];
    }
    getSupportedExtension() {
        return '.json';
    }
    compile(code, filename) {
        this.raw = JSON.parse(TEST_BASE);
        const preprocessedCode = this._preProcess(code);
        if (!preprocessedCode)
            return [];
        return super.compile(preprocessedCode, filename);
    }
    _preProcess(code) {
        const parsedCode = JSON.parse(code);
        this._fixture.name = parsedCode.title;
        this._test.name = parsedCode.title;
        if (!parsedCode.steps)
            return null;
        parsedCode.steps.forEach((step, i) => this._processStep(step, i));
        return JSON.stringify(this.raw);
    }
    _processStep(step, i) {
        const transformer = factory_1.CommandTransformerFactory.create(step, i);
        if (transformer) {
            this._onBeforeCommandExecute(step);
            this._test.commands.push(transformer.transform());
            this._onAfterCommandExecute(step);
        }
    }
    _onBeforeCommandExecute(step) {
        if (!step.frame)
            return;
        const frames = step.frame;
        for (const frame of frames)
            this._test.commands.push(new switch_to_iframe_1.SwitchToIframeCommandTransformer({ frame }, 0).transform());
    }
    _onAfterCommandExecute(step) {
        this._test.commands.push(new switch_to_main_window_1.SwitchToMainWindowCommandTransformer(step, 0).transform());
    }
}
exports.default = DevToolsTestFileCompiler;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY29tcGlsZXIvdGVzdC1maWxlL2Zvcm1hdHMvZGV2LXRvb2xzL2NvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsaURBQXlDO0FBRXpDLGdEQUErRDtBQUMvRCxrRUFBK0U7QUFDL0UsNEVBQXdGO0FBU3hGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDN0IsUUFBUSxFQUFFO1FBQ047WUFDSSxJQUFJLEVBQUcsYUFBYTtZQUNwQixLQUFLLEVBQUU7Z0JBQ0g7b0JBQ0ksSUFBSSxFQUFNLFVBQVU7b0JBQ3BCLFFBQVEsRUFBRSxFQUFFO2lCQUNmO2FBQ0o7U0FDSjtLQUNKO0NBQ0osQ0FBQyxDQUFDO0FBRUgsTUFBcUIsd0JBQXlCLFNBQVEsYUFBbUI7SUFBekU7O1FBQ1ksUUFBRyxHQUFpQixFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQztJQWtFakQsQ0FBQztJQWhFRyxTQUFTO1FBQ0wsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELElBQUksUUFBUTtRQUNSLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELElBQUksS0FBSztRQUNMLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELHFCQUFxQjtRQUNqQixPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsT0FBTyxDQUFFLElBQVksRUFBRSxRQUFnQjtRQUNuQyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFakMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWhELElBQUksQ0FBQyxnQkFBZ0I7WUFDakIsT0FBTyxFQUFFLENBQUM7UUFFZCxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELFdBQVcsQ0FBRSxJQUFZO1FBQ3JCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFcEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQztRQUN0QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBTSxVQUFVLENBQUMsS0FBSyxDQUFDO1FBRXRDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSztZQUNqQixPQUFPLElBQUksQ0FBQztRQUVoQixVQUFVLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQTBCLEVBQUUsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWhHLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELFlBQVksQ0FBRSxJQUEwQixFQUFFLENBQVM7UUFDL0MsTUFBTSxXQUFXLEdBQUcsbUNBQXlCLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUU5RCxJQUFJLFdBQVcsRUFBRTtZQUNiLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNuQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3JDO0lBQ0wsQ0FBQztJQUVELHVCQUF1QixDQUFFLElBQTBCO1FBQy9DLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSztZQUNYLE9BQU87UUFFWCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBaUIsQ0FBQztRQUV0QyxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU07WUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksbURBQWdDLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ2pHLENBQUM7SUFFRCxzQkFBc0IsQ0FBRSxJQUEwQjtRQUM5QyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSw0REFBb0MsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUM1RixDQUFDO0NBQ0o7QUFuRUQsMkNBbUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJhd1Rlc3RGaWxlQ29tcGlsZXIgZnJvbSAnLi4vcmF3JztcbmltcG9ydCBUZXN0IGZyb20gJy4uLy4uLy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdGVzdCc7XG5pbXBvcnQgeyBDb21tYW5kVHJhbnNmb3JtZXJGYWN0b3J5IH0gZnJvbSAnLi9jb21tYW5kcy9mYWN0b3J5JztcbmltcG9ydCB7IFN3aXRjaFRvSWZyYW1lQ29tbWFuZFRyYW5zZm9ybWVyIH0gZnJvbSAnLi9jb21tYW5kcy9zd2l0Y2gtdG8taWZyYW1lJztcbmltcG9ydCB7IFN3aXRjaFRvTWFpbldpbmRvd0NvbW1hbmRUcmFuc2Zvcm1lciB9IGZyb20gJy4vY29tbWFuZHMvc3dpdGNoLXRvLW1haW4td2luZG93JztcblxuaW1wb3J0IHtcbiAgICBEZXZUb29sc1JlY29yZGVyU3RlcCxcbiAgICBSYXdGaXh0dXJlLFxuICAgIFJhd1JlY29yZGluZyxcbiAgICBSYXdUZXN0LFxufSBmcm9tICcuL3R5cGVzJztcblxuY29uc3QgVEVTVF9CQVNFID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgIGZpeHR1cmVzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICAgIG5hbWU6ICAnTmV3IEZpeHR1cmUnLFxuICAgICAgICAgICAgdGVzdHM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICAgICAnTmV3IFRlc3QnLFxuICAgICAgICAgICAgICAgICAgICBjb21tYW5kczogW10sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgXSxcbn0pO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEZXZUb29sc1Rlc3RGaWxlQ29tcGlsZXIgZXh0ZW5kcyBSYXdUZXN0RmlsZUNvbXBpbGVyIHtcbiAgICBwcml2YXRlIHJhdzogUmF3UmVjb3JkaW5nID0geyBmaXh0dXJlczogW10gfTtcblxuICAgIF9oYXNUZXN0cyAoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGdldCBfZml4dHVyZSAoKTogUmF3Rml4dHVyZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJhdy5maXh0dXJlc1swXTtcbiAgICB9XG5cbiAgICBnZXQgX3Rlc3QgKCk6IFJhd1Rlc3Qge1xuICAgICAgICByZXR1cm4gdGhpcy5fZml4dHVyZS50ZXN0c1swXTtcbiAgICB9XG5cbiAgICBnZXRTdXBwb3J0ZWRFeHRlbnNpb24gKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAnLmpzb24nO1xuICAgIH1cblxuICAgIGNvbXBpbGUgKGNvZGU6IHN0cmluZywgZmlsZW5hbWU6IHN0cmluZyk6IFRlc3RbXSB7XG4gICAgICAgIHRoaXMucmF3ID0gSlNPTi5wYXJzZShURVNUX0JBU0UpO1xuXG4gICAgICAgIGNvbnN0IHByZXByb2Nlc3NlZENvZGUgPSB0aGlzLl9wcmVQcm9jZXNzKGNvZGUpO1xuXG4gICAgICAgIGlmICghcHJlcHJvY2Vzc2VkQ29kZSlcbiAgICAgICAgICAgIHJldHVybiBbXTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuY29tcGlsZShwcmVwcm9jZXNzZWRDb2RlLCBmaWxlbmFtZSk7XG4gICAgfVxuXG4gICAgX3ByZVByb2Nlc3MgKGNvZGU6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgICAgICBjb25zdCBwYXJzZWRDb2RlID0gSlNPTi5wYXJzZShjb2RlKTtcblxuICAgICAgICB0aGlzLl9maXh0dXJlLm5hbWUgPSBwYXJzZWRDb2RlLnRpdGxlO1xuICAgICAgICB0aGlzLl90ZXN0Lm5hbWUgICAgPSBwYXJzZWRDb2RlLnRpdGxlO1xuXG4gICAgICAgIGlmICghcGFyc2VkQ29kZS5zdGVwcylcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgIHBhcnNlZENvZGUuc3RlcHMuZm9yRWFjaCgoc3RlcDogRGV2VG9vbHNSZWNvcmRlclN0ZXAsIGk6IG51bWJlcikgPT4gdGhpcy5fcHJvY2Vzc1N0ZXAoc3RlcCwgaSkpO1xuXG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnJhdyk7XG4gICAgfVxuXG4gICAgX3Byb2Nlc3NTdGVwIChzdGVwOiBEZXZUb29sc1JlY29yZGVyU3RlcCwgaTogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHRyYW5zZm9ybWVyID0gQ29tbWFuZFRyYW5zZm9ybWVyRmFjdG9yeS5jcmVhdGUoc3RlcCwgaSk7XG5cbiAgICAgICAgaWYgKHRyYW5zZm9ybWVyKSB7XG4gICAgICAgICAgICB0aGlzLl9vbkJlZm9yZUNvbW1hbmRFeGVjdXRlKHN0ZXApO1xuICAgICAgICAgICAgdGhpcy5fdGVzdC5jb21tYW5kcy5wdXNoKHRyYW5zZm9ybWVyLnRyYW5zZm9ybSgpKTtcbiAgICAgICAgICAgIHRoaXMuX29uQWZ0ZXJDb21tYW5kRXhlY3V0ZShzdGVwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9vbkJlZm9yZUNvbW1hbmRFeGVjdXRlIChzdGVwOiBEZXZUb29sc1JlY29yZGVyU3RlcCk6IHZvaWQge1xuICAgICAgICBpZiAoIXN0ZXAuZnJhbWUpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY29uc3QgZnJhbWVzID0gc3RlcC5mcmFtZSBhcyBudW1iZXJbXTtcblxuICAgICAgICBmb3IgKGNvbnN0IGZyYW1lIG9mIGZyYW1lcylcbiAgICAgICAgICAgIHRoaXMuX3Rlc3QuY29tbWFuZHMucHVzaChuZXcgU3dpdGNoVG9JZnJhbWVDb21tYW5kVHJhbnNmb3JtZXIoeyBmcmFtZSB9LCAwKS50cmFuc2Zvcm0oKSk7XG4gICAgfVxuXG4gICAgX29uQWZ0ZXJDb21tYW5kRXhlY3V0ZSAoc3RlcDogRGV2VG9vbHNSZWNvcmRlclN0ZXApOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fdGVzdC5jb21tYW5kcy5wdXNoKG5ldyBTd2l0Y2hUb01haW5XaW5kb3dDb21tYW5kVHJhbnNmb3JtZXIoc3RlcCwgMCkudHJhbnNmb3JtKCkpO1xuICAgIH1cbn1cbiJdfQ==